---
alwaysApply: true
---
# Nomur 微商管理系统 - 项目规范

## 项目概述
这是一个基于 uni-app + Vue3 + TypeScript 的微商代理管理小程序，采用双端设计：
- **管理端**：创始人/公司视角，负责商品录入、发货开单、代理管理、财务审核
- **用户端**：代理商视角，查看业绩、余额、任务进度

## 技术栈
- 框架：uni-app (Vue 3 + TypeScript)
- UI库：自定义组件（强调勾选式交互）
- 状态管理：Pinia
- 样式：SCSS + CSS变量
- 构建：Vite

## 核心设计原则

### 1. 交互体验优先（UX First）
- ❌ 禁止使用下拉菜单（Dropdown）
- ✅ 使用平铺勾选框（Checkbox/Tag Grid）
- ✅ 支持多选操作
- ✅ 图片上传无数量限制
- ✅ 实时计算（毫秒级响应）

### 2. 移动端优化
- 大按钮、大触控区域（最小 44px）
- 单手操作友好
- 减少输入，多用选择
- 关键操作不超过3步

### 3. 视觉规范
- 主色：#1890FF（科技蓝）
- 成功：#52C41A
- 警告：#FAAD14
- 危险：#FF4D4F
- 背景：#F5F7FA
- 卡片圆角：12rpx
- 阴影：0 2rpx 12rpx rgba(0,0,0,0.08)

## 目录结构
```
src/
├── components/          # 公共组件
│   ├── TagSelect/       # 勾选标签组件
│   ├── ImageUploader/   # 图片上传组件
│   ├── QuickCalc/       # 实时计算组件
│   └── BalanceCard/     # 余额卡片组件
├── pages/
│   ├── admin/           # 管理端页面
│   │   ├── dashboard/   # 数据驾驶舱
│   │   ├── products/    # 商品管理
│   │   ├── agents/      # 代理管理
│   │   ├── orders/      # 极速开单
│   │   └── finance/     # 财务管理
│   └── agent/           # 代理端页面
│       ├── home/        # 首页（业绩看板）
│       ├── balance/     # 余额明细
│       └── promotions/  # 促销查询
├── stores/              # Pinia状态管理
├── types/               # TypeScript类型定义
├── utils/               # 工具函数
├── api/                 # API请求封装
└── static/              # 静态资源
```

## 数据模型

### 商品 Product
```typescript
interface Product {
  id: string
  name: string
  image: string
  price: number
  weight: number // 单位：kg
  materials: string[] // 素材库图片URLs
  createdAt: Date
}
```

### 代理商 Agent
```typescript
interface Agent {
  id: string
  avatar: string
  name: string
  phone1: string
  phone2?: string
  address: string
  yearlyTargets: {
    productA: number // A产品年度目标（箱）
    mixed: number    // 混合产品年度目标（箱）
  }
  balance: number // 余额（可为负数）
}
```

### 订单 Order
```typescript
interface Order {
  id: string
  agentId: string
  items: OrderItem[]
  totalWeight: number
  totalAmount: number
  driverPhone: string
  promotionId?: string
  giftItems?: GiftItem[]
  status: 'pending' | 'shipped' | 'completed'
  createdAt: Date
}
```

### 资金流水 Transaction
```typescript
interface Transaction {
  id: string
  agentId: string
  type: 'recharge' | 'deduct'
  reason: 'gift' | 'payment' | 'shipping' | 'fine' | 'transfer_in' | 'transfer_out'
  amount: number
  proof?: string // 凭证图片
  relatedOrderId?: string
  createdAt: Date
}
```

## 业务规则

### 促销活动
- 规则：每满100件赠送指定商品
- 需透明展示：已购数量、当前赠品数量

### 调货逻辑（原子操作）
```
A代理 -> B代理 调货
1. 公司退款给A的账户 (+amount)
2. 公司从B的账户扣款 (-amount)
必须使用事务确保两步操作同时成功或失败
```

### 余额显示
- 支持负数显示（欠账状态）
- 负数用红色显示，正数用绿色显示

## 组件开发规范

### TagSelect 标签选择组件
- 必须支持单选/多选模式
- 标签需有选中/未选中明显视觉差异
- 选中时有轻微震动反馈

### ImageUploader 图片上传
- 支持多图上传
- 显示上传进度
- 支持预览和删除
- 压缩后上传（保证速度）

### QuickCalc 实时计算
- 使用 computed 或 watch 实现毫秒级响应
- 数量变化时自动计算：总重量、总费用、运费预估

## API 设计规范
- RESTful 风格
- 统一响应格式：{ code, message, data }
- 错误统一处理
- 请求需带 token 认证

## 代码规范
- 组件名使用 PascalCase
- 文件名使用 kebab-case
- 变量名使用 camelCase
- 常量使用 UPPER_SNAKE_CASE
- 必须添加 TypeScript 类型注解
- 禁止使用 any 类型

### ⚠️ 重要提醒：代码改动后必须重新构建
**每次修改代码后，必须重新构建项目才能生效！**
- 构建命令：`npm run build:mp-weixin`（微信小程序）和 `npm run build:h5`（H5）
- 构建完成后，需要重新部署或重新加载小程序/应用

## Git 提交规范
- feat: 新功能
- fix: 修复bug
- style: 样式调整
- refactor: 重构
- docs: 文档更新

---

## 云服务器信息

### 系统配置
| 项目 | 信息 |
|------|------|
| 操作系统 | Ubuntu 22.04 LTS |
| 内核版本 | 5.15.0-160-generic |
| 主机名 | VM-0-10-ubuntu |
| CPU | Intel Xeon E5-26xx v4 × 4 核心 |
| 内存 | 7.6 GB |
| 磁盘 | 59G 总计，52G 可用 |

### 网络配置
| 项目 | 信息 |
|------|------|
| 服务器 IP | 115.159.72.71 |
| 域名 | linkmate.site |
| DNS 解析 | 泛解析 (*.linkmate.site) |
| 云数据库 | 8.154.33.100:3306 (MySQL) |
| 数据库用户 | root |
| 数据库密码 | Xk9mP2vL5nQ8wR3jF6yH1bT4cU7eA0sDzGqW |

### 已安装环境与工具

| 工具/服务 | 版本 | 状态 | 安装日期 |
|-----------|------|------|----------|
| Nginx | 1.18.0 | ✅ 运行中 | 预装 |
| Python | 3.10.12 | ✅ 可用 | 预装 |
| Git | 2.34.1 | ✅ 可用 | 预装 |
| Node.js | 20.19.6 | ✅ 可用 | 2024-12-20 |
| npm | 10.8.2 | ✅ 可用 | 2024-12-20 |
| acme.sh | 3.x | ✅ 自动续期 | 2024-12-20 |

### SSL 证书配置

| 域名 | 证书路径 | 有效期 | 自动续期 |
|------|----------|--------|----------|
| autovid.linkmate.site | /etc/nginx/ssl/linkmate.pem | 90天 | ✅ acme.sh |
| school.linkmate.site | /etc/nginx/ssl/linkmate.pem | 90天 | ✅ acme.sh |
| typing.linkmate.site | /etc/nginx/ssl/linkmate.pem | 90天 | ✅ acme.sh |
| oapac.linkmate.site | /etc/nginx/ssl/linkmate.pem | 90天 | ✅ acme.sh |
| fraud.linkmate.site | /etc/nginx/ssl/fraud.linkmate.site.pem | 90天 | ✅ acme.sh (dns_ali) |
| nomur.linkmate.site | /etc/nginx/ssl/nomur.linkmate.site.pem | 90天 | ✅ acme.sh (dns_ali) |

### 后端 API 服务

| 项目 | 信息 |
|------|------|
| 服务地址 | http://127.0.0.1:3001 |
| 数据库 | nomur (MySQL 8.154.33.100:3306) |
| 进程管理 | PM2 (nomur-api) |
| 代码目录 | /var/www/nomur/server |
| API 路由 | /api/* (Nginx 反向代理) |

### SSL 证书签发方式

**阿里云 DNS API 已配置**，可自动添加 TXT 记录完成验证。

#### 签发新证书
```bash
# 使用阿里云 DNS 验证（推荐，适用于所有域名）
~/.acme.sh/acme.sh --issue -d <域名> --dns dns_ali

# 使用 HTTP 验证（需确保国外可访问）
~/.acme.sh/acme.sh --issue -d <域名> -w <网站根目录>
```

#### 安装证书到 Nginx
```bash
~/.acme.sh/acme.sh --install-cert -d <域名> \
  --key-file /etc/nginx/ssl/<域名>.key \
  --fullchain-file /etc/nginx/ssl/<域名>.pem \
  --reloadcmd "systemctl reload nginx"
```

#### 更新 Nginx 配置
```nginx
ssl_certificate /etc/nginx/ssl/<域名>.pem;
ssl_certificate_key /etc/nginx/ssl/<域名>.key;
```

#### 查看已签发证书
```bash
~/.acme.sh/acme.sh --list
```

> **注意**: 包含敏感词（如 fraud）的域名可能被 DNS 服务商拦截 HTTP 验证，请使用 DNS 验证方式。

---

> **注意**: 每次安装新软件或工具时，请更新上方的「已安装环境与工具」表格。
