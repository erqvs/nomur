"use strict";const e=require("../../../common/vendor.js"),a=require("../../../common/assets.js"),t=require("../../../api/index.js");Math||(n+o)();const n=()=>"../../../components/ImageUploader/index.js",o=()=>"../../../components/QuickInput/index.js",l=e.defineComponent({__name:"index",setup(n){const o=e.ref([]),l=e.ref(!1),u=e.ref(!1),r=e.ref(!1),i=e.ref(!1),c=e.ref(""),s=e.ref(""),v=e.ref(null),m=e.ref(null),d=e.ref(null),g=[{label:"全部",value:"all"},{label:"收款",value:"recharge"},{label:"扣费",value:"deduct"}],f=e.ref("all"),h=e.computed(()=>v.value?"all"===f.value?v.value.transactions:v.value.transactions.filter(e=>e.type===f.value):[]),p=e.ref({name:"",accountNo:"",bankName:"",qrCode:[]}),w=e.ref({reason:"withdraw",amount:0,remark:""}),N=async()=>{try{const e=await t.paymentAccountApi.getAll();if(!Array.isArray(e))return void(o.value=[]);o.value=await Promise.all(e.map(async e=>{if(!e||!e.id)return null;try{const a=await t.paymentAccountApi.getBalanceDetails(e.id);return{...e,balance:a.account.balance,accountNo:e.accountNo||e.account_no,bankName:e.bankName||e.bank_name,qrCode:e.qrCode||e.qr_code}}catch{return{...e,balance:0}}})).then(e=>e.filter(e=>null!==e))}catch(a){console.error("加载收款账户失败:",a),e.index.showToast({title:"加载失败",icon:"none"}),o.value=[]}},b=()=>{l.value=!1,u.value=!1,d.value=null,p.value={name:"",accountNo:"",bankName:"",qrCode:[]}},k=async()=>{if(p.value.name&&""!==p.value.name.trim())try{const a=p.value.qrCode.length>0?p.value.qrCode[0]:void 0;d.value?(await t.paymentAccountApi.update(d.value.id,{name:p.value.name.trim(),accountNo:p.value.accountNo.trim()||void 0,bankName:p.value.bankName.trim()||void 0,qrCode:a}),e.index.showToast({title:"更新成功",icon:"success"})):(await t.paymentAccountApi.create({name:p.value.name.trim(),accountNo:p.value.accountNo.trim()||void 0,bankName:p.value.bankName.trim()||void 0,qrCode:a}),e.index.showToast({title:"添加成功",icon:"success"})),b(),await N()}catch(a){e.index.showToast({title:a.message||(d.value?"更新失败":"添加失败"),icon:"none"})}else e.index.showToast({title:"请输入账户名称",icon:"none"})},x=async()=>{if(c.value)if(!w.value.amount||w.value.amount<=0)e.index.showToast({title:"请输入扣费金额",icon:"none"});else if("other"!==w.value.reason||w.value.remark)try{const a="other"===w.value.reason?w.value.remark:w.value.reason;if(await t.paymentAccountApi.deduct(c.value,{amount:w.value.amount,reason:a,remark:w.value.remark||void 0}),e.index.showToast({title:"扣费成功",icon:"success"}),i.value=!1,w.value={reason:"withdraw",amount:0,remark:""},c.value){const e=await t.paymentAccountApi.getBalanceDetails(c.value);v.value=e}await N()}catch(a){e.index.showToast({title:a.message||"扣费失败",icon:"none"})}else e.index.showToast({title:"请输入扣费原因",icon:"none"});else e.index.showToast({title:"请选择收款账户",icon:"none"})},y=e=>({gift:"赠送",payment:"打款充值",freight:"运费",shipping:"发货扣款",fine:"罚款",transfer_in:"调货收入",transfer_out:"调货支出",marketing:"营销退款"}[e]||e),q=e=>{const a=new Date(e),t=new Date,n=new Date(t.getFullYear(),t.getMonth(),t.getDate()),o=new Date(a.getFullYear(),a.getMonth(),a.getDate()),l=Math.floor((n.getTime()-o.getTime())/864e5),u=String(a.getMonth()+1).padStart(2,"0"),r=String(a.getDate()).padStart(2,"0"),i=String(a.getHours()).padStart(2,"0"),c=String(a.getMinutes()).padStart(2,"0");if(0===l)return`${i}:${c}`;if(1===l)return`昨天 ${i}:${c}`;if(l<7)return`${u}-${r} ${i}:${c}`;if(a.getFullYear()===t.getFullYear())return`${u}-${r} ${i}:${c}`;return`${a.getFullYear()}-${u}-${r} ${i}:${c}`};return e.onMounted(()=>{N()}),e.onShow(()=>{N()}),(n,$)=>e.e({a:e.f(o.value,(a,n,l)=>e.e({a:e.t(a.name),b:e.t((a.balance||0).toLocaleString()),c:(a.balance||0)<0?1:"",d:a.accountNo},a.accountNo?{e:e.t(a.accountNo)}:{},{f:a.bankName},a.bankName?{g:e.t(a.bankName)}:{},{h:e.o(n=>(async(a,n)=>{try{c.value=a,s.value=n;const e=o.value.find(e=>e.id===a);m.value=e||null;const l=await t.paymentAccountApi.getBalanceDetails(a);v.value=l,f.value="all",r.value=!0}catch(l){e.index.showToast({title:"加载失败",icon:"none"})}})(a.id,a.name),a.id),i:e.o(e=>(e=>{d.value=e,p.value={name:e.name||"",accountNo:e.accountNo||"",bankName:e.bankName||"",qrCode:e.qrCode?[e.qrCode]:[]},u.value=!0})(a),a.id),j:e.o(n=>{return o=a.id,l=a.name,void e.index.showModal({title:"删除收款账户",content:`确定要删除收款账户"${l}"吗？\n\n注意：如果该账户已有交易记录，将无法删除。`,confirmText:"删除",confirmColor:"#FF4D4F",success:async a=>{if(a.confirm)try{await t.paymentAccountApi.delete(o),e.index.showToast({title:"删除成功",icon:"success"}),await N()}catch(n){e.index.showToast({title:n.message||"删除失败",icon:"none"})}}});var o,l},a.id),k:a.id})),b:a._imports_0$5,c:a._imports_1$6,d:0===o.value.length},0===o.value.length?{e:a._imports_2$2}:{},{f:e.o(e=>l.value=!0),g:l.value||u.value},l.value||u.value?{h:e.t(d.value?"编辑收款账户":"添加收款账户"),i:p.value.name,j:e.o(e=>p.value.name=e.detail.value),k:p.value.accountNo,l:e.o(e=>p.value.accountNo=e.detail.value),m:p.value.bankName,n:e.o(e=>p.value.bankName=e.detail.value),o:e.o(e=>p.value.qrCode=e),p:e.p({maxCount:1,addText:"上传二维码",modelValue:p.value.qrCode}),q:e.o(b),r:e.t(d.value?"保存":"添加"),s:e.o(k),t:e.o(()=>{}),v:e.o(b)}:{},{w:r.value},r.value?e.e({x:e.t(s.value),y:v.value},v.value?{z:e.t(v.value.account.balance.toLocaleString()),A:v.value.account.balance<0?1:""}:{},{B:m.value},m.value?e.e({C:m.value.accountNo},m.value.accountNo?{D:e.t(m.value.accountNo)}:{},{E:m.value.bankName},m.value.bankName?{F:e.t(m.value.bankName)}:{},{G:m.value.qrCode},m.value.qrCode?{H:m.value.qrCode,I:e.o(a=>{return t=m.value.qrCode,void e.index.previewImage({urls:[t]});var t})}:{}):{},{J:e.f(g,(a,t,n)=>({a:e.t(a.label),b:a.value,c:f.value===a.value?1:"",d:e.o(e=>f.value=a.value,a.value)})),K:e.f(h.value,(a,t,n)=>{return e.e({a:(o=a.reason,{gift:"/static/icons/gift.svg",payment:"/static/icons/credit-card.svg",freight:"/static/icons/truck.svg",shipping:"/static/icons/box.svg",fine:"/static/icons/warning.svg",transfer_in:"/static/icons/arrow-down-circle.svg",transfer_out:"/static/icons/arrow-up-circle.svg",marketing:"/static/icons/target.svg"}[o]||"/static/icons/credit-card.svg"),b:a.agentName},a.agentName?{c:e.t(a.agentName),d:e.o(t=>{return n=a.agentId,void e.index.navigateTo({url:`/pages/admin/agents/detail?id=${n}`});var n},a.id)}:{},{e:e.t(y(a.reason)),f:e.t(a.amount>0?"+":""),g:e.t(Math.abs(a.amount).toLocaleString()),h:a.amount>0?1:"",i:a.amount<0?1:"",j:e.t(q(a.createdAt)),k:a.remark},a.remark?{l:e.t(a.remark)}:{},{m:a.id});var o}),L:0===h.value.length},(h.value.length,{}),{M:e.o(e=>i.value=!0),N:e.o(e=>r.value=!1),O:e.o(()=>{}),P:e.o(e=>r.value=!1)}):{},{Q:i.value},i.value?{R:e.t(s.value),S:"withdraw"===w.value.reason?1:"",T:e.o(e=>w.value.reason="withdraw"),U:"fee"===w.value.reason?1:"",V:e.o(e=>w.value.reason="fee"),W:"other"===w.value.reason?1:"",X:e.o(e=>w.value.reason="other"),Y:e.t("other"===w.value.reason?"扣费原因":"备注（可选）"),Z:"other"===w.value.reason?"请输入扣费原因":"请输入备注信息",aa:w.value.remark,ab:e.o(e=>w.value.remark=e.detail.value),ac:e.o(e=>w.value.amount=e),ad:e.p({label:"扣费金额",type:"digit",prefix:"¥",showQuickNumbers:!0,quickNumbers:[100,500,1e3,5e3],modelValue:w.value.amount}),ae:e.o(e=>i.value=!1),af:e.o(x),ag:e.o(()=>{}),ah:e.o(e=>i.value=!1)}:{})}}),u=e._export_sfc(l,[["__scopeId","data-v-c2cf54a1"]]);wx.createPage(u);
