"use strict";const e=require("../../../common/vendor.js"),t=require("../../../common/assets.js"),a=require("../../../stores/app.js");Math||(i+o+u)();const i=()=>"../../../components/TagSelect/index.js",o=()=>"../../../components/QuickInput/index.js",u=()=>"../../../components/ImageUploader/index.js",n=e.defineComponent({__name:"index",setup(i){const o=a.useAppStore(),u=e.ref([]),n=e.ref(!1),l=e.ref({}),d=e.ref(!1),r=e.ref([]),s=e.ref({agentId:null,items:[],driverPhone:"",promotionIds:[],truckTypeId:null,images:[]}),c=async()=>{try{const t=(await e.index.request({url:"https://nomur.linkmate.site/api/truck-types",method:"GET"})).data;if(0===t.code){u.value=t.data;const e=u.value.find(e=>e.isDefault);e&&(s.value.truckTypeId=e.id)}}catch(t){console.error("加载车型失败",t)}};e.onMounted(()=>{c()}),e.onShow(()=>{c()});const v=e.computed(()=>u.value.find(e=>e.id===s.value.truckTypeId)),p=()=>{n.value=!1,e.index.navigateTo({url:"/pages/admin/trucks/index"})},m=e.computed(()=>v.value?j.value/v.value.maxWeight*100:0),f=e.computed(()=>v.value?v.value.minWeight/v.value.maxWeight*100:0),g=e.computed(()=>v.value&&0!==j.value?j.value<v.value.minWeight?"insufficient":j.value>v.value.maxWeight?"overload":"success":"empty"),h=e.computed(()=>({empty:"/static/icons/truck.svg",insufficient:"/static/icons/warning.svg",success:"/static/icons/check-circle.svg",overload:"/static/icons/x-circle.svg"}[g.value])),y=e.computed(()=>({empty:"请添加商品",insufficient:"重量不足",success:"整车达标！",overload:"超载"}[g.value])),I=e.computed(()=>o.agents.map(e=>({label:e.name,value:e.id,subLabel:`¥${e.balance.toLocaleString()}`}))),q=e.computed(()=>o.products),x=e.computed(()=>{const e={};return o.products.forEach(t=>{let a="其他";t.name.includes("芒果")?a="芒果类":t.name.includes("茶")?a="茶类":(t.name.includes("龙眼")||t.name.includes("水果"))&&(a="水果类"),e[a]||(e[a]={type:a,products:[]}),e[a].products.push(t)}),Object.values(e)}),b=e=>r.value.some(t=>t.type===e),w=e=>{const t=r.value.find(t=>t.type===e);return(null==t?void 0:t.quantity)||0},S=(e,t)=>{const a=r.value.find(t=>t.type===e);if(a){const e=10===Math.abs(t)?10:1;a.quantity=Math.max(1,a.quantity+(t>0?e:-e)),k()}},k=()=>{s.value.items=[],r.value.forEach(e=>{if(0===e.productIds.length)return;const t=o.products.filter(t=>e.productIds.includes(t.id));if(0===t.length)return;let a=e.quantity;const i={};for(;a>0;){const e=t[Math.floor(Math.random()*t.length)],o=Math.min(a,Math.floor(Math.random()*a)+1);i[e.id]=(i[e.id]||0)+o,a-=o}Object.entries(i).forEach(([e,t])=>{const a=o.products.find(t=>t.id===e);if(a){const i=s.value.items.find(t=>t.productId===e);i?i.quantity+=t:s.value.items.push({productId:a.id,productName:a.name,quantity:t,price:a.price,weight:a.weight})}})})};e.watch(d,()=>{d.value?s.value.items=[]:r.value=[]});const M=e.computed(()=>o.promotions.filter(e=>e.isActive).map(e=>({label:e.name,value:e.id,subLabel:e.description})));e.computed(()=>s.value.items);const T=e=>s.value.items.some(t=>t.productId===e),L=(e,t)=>{const a=s.value.items.find(t=>t.productId===e);if(a){const i=t>0?10:1;a.quantity=Math.max(1,a.quantity+t*i),l.value[e]=a.quantity}},W=e=>{const t=s.value.items.find(t=>t.productId===e);return(null==t?void 0:t.quantity)||0},P=e.computed(()=>s.value.items.reduce((e,t)=>e+t.quantity,0)),j=e.computed(()=>s.value.items.reduce((e,t)=>e+t.quantity*t.weight,0)),N=e.computed(()=>s.value.items.reduce((e,t)=>e+t.quantity*t.price,0)),E=e.computed(()=>{if(!s.value.promotionIds||0===s.value.promotionIds.length)return[];const e=[];return s.value.promotionIds.forEach(t=>{const a=o.promotions.find(e=>e.id===t);if(a){const t=(e=>e.conditionProducts&&0!==e.conditionProducts.length?s.value.items.filter(t=>e.conditionProducts.includes(t.productId)).reduce((e,t)=>e+t.quantity,0):P.value)(a),i=Math.floor(t/a.threshold);i>0&&e.push({name:a.name,gifts:a.gifts.map(e=>e.type?{productName:`${e.type}（随机分配）`,quantity:e.quantity*i}:{productName:e.productName,quantity:e.quantity*i})})}}),e}),_=e.computed(()=>o.agents.find(e=>e.id===s.value.agentId)),A=e.computed(()=>!_.value||_.value.balance>=N.value),D=async()=>{if(!s.value.agentId)return void e.index.showToast({title:"请选择代理商",icon:"none"});if(0===s.value.items.length)return void e.index.showToast({title:"请选择商品",icon:"none"});if("insufficient"===g.value){if(!(await new Promise(t=>{var a;e.index.showModal({title:"整车重量不足",content:`当前重量 ${j.value.toLocaleString()}kg，未达到整车标准 ${null==(a=v.value)?void 0:a.minWeight.toLocaleString()}kg，是否继续开单？`,success:e=>t(e.confirm)})})))return}if("overload"===g.value)return void e.index.showToast({title:"超载，请减少商品",icon:"none"});const t=_.value;let a=[];const i=new Map;s.value.promotionIds&&s.value.promotionIds.length>0&&(s.value.promotionIds.forEach(e=>{const t=o.promotions.find(t=>t.id===e);if(t){const e=t.conditionProducts&&t.conditionProducts.length>0?s.value.items.filter(e=>t.conditionProducts.includes(e.productId)).reduce((e,t)=>e+t.quantity,0):P.value,a=Math.floor(e/t.threshold);a>0&&t.gifts.forEach(e=>{if(e.type&&e.productIds&&e.productIds.length>0){const t=e.quantity*a;for(let a=0;a<t;a++){const t=Math.floor(Math.random()*e.productIds.length),a=e.productIds[t],o=i.get(a)||0;i.set(a,o+1)}}else{const t=e.productId,o=i.get(t)||0;i.set(t,o+e.quantity*a)}})}}),a=Array.from(i.entries()).map(([e,t])=>{const a=o.products.find(t=>t.id===e);return{productId:e,productName:(null==a?void 0:a.name)||e,quantity:t}}));try{await o.createOrder({agentId:s.value.agentId,agentName:t.name,items:s.value.items,totalWeight:j.value,totalAmount:N.value,driverPhone:s.value.driverPhone||void 0,promotionId:s.value.promotionIds&&s.value.promotionIds.length>0?JSON.stringify(s.value.promotionIds):void 0,giftItems:a.length>0?a:void 0,images:s.value.images}),e.index.showToast({title:"开单成功",icon:"success"}),setTimeout(()=>{var e;s.value={agentId:null,items:[],driverPhone:"",promotionIds:[],truckTypeId:(null==(e=u.value.find(e=>e.isDefault))?void 0:e.id)||null,images:[]}},1500)}catch(n){e.index.showToast({title:"开单失败",icon:"none"})}};return(a,i)=>{var o;return e.e({a:e.o(e=>s.value.agentId=e),b:e.p({options:I.value,label:"",modelValue:s.value.agentId}),c:d.value?"":1,d:e.o(e=>d.value=!1),e:d.value?1:"",f:e.o(e=>d.value=!0),g:!d.value},d.value?{i:e.f(x.value,(t,a,i)=>e.e({a:b(t.type)},(b(t.type),{}),{b:e.t(t.type),c:e.t(t.products.map(e=>e.name).join("、")),d:e.o(a=>(t=>{e.index.vibrateShort({type:"light"});const a=r.value.findIndex(e=>e.type===t);if(a>-1)r.value.splice(a,1),k();else{const e=x.value.find(e=>e.type===t);e&&(r.value.push({type:t,quantity:10,productIds:e.products.map(e=>e.id)}),k())}})(t.type),t.type),e:b(t.type)},b(t.type)?{f:e.o(e=>S(t.type,-10),t.type),g:e.o(e=>S(t.type,-1),t.type),h:w(t.type),i:e.o(e=>{var a,i;return((e,t)=>{const a=r.value.find(t=>t.type===e);a&&(a.quantity=Math.max(1,t||1),k())})(t.type,Number((null==(a=e.detail)?void 0:a.value)??(null==(i=e.target)?void 0:i.value)??0))},t.type),j:e.o(e=>S(t.type,1),t.type),k:e.o(e=>S(t.type,10),t.type),l:e.o(()=>{},t.type)}:{},{m:t.type,n:b(t.type)?1:""}))}:{h:e.f(q.value,(t,a,i)=>e.e({a:T(t.id)},(T(t.id),{}),{b:e.t(t.name),c:e.o(a=>(t=>{if(e.index.vibrateShort({type:"light"}),T(t)){const e=s.value.items.find(e=>e.productId===t);e&&(l.value[t]=e.quantity),s.value.items=s.value.items.filter(e=>e.productId!==t)}else{const e=q.value.find(e=>e.id===t);if(e){const a=l.value[t];s.value.items.push({productId:e.id,productName:e.name,quantity:a||10,price:e.price,weight:e.weight})}}})(t.id),t.id),d:T(t.id)},T(t.id)?{e:e.o(e=>L(t.id,-1),t.id),f:W(t.id),g:e.o(e=>{var a,i;return((e,t)=>{const a=s.value.items.find(t=>t.productId===e);a&&(a.quantity=Math.max(1,t||1),l.value[e]=a.quantity)})(t.id,Number((null==(a=e.detail)?void 0:a.value)??(null==(i=e.target)?void 0:i.value)??0))},t.id),h:e.o(e=>L(t.id,1),t.id),i:e.o(()=>{},t.id)}:{},{j:t.id,k:T(t.id)?1:""}))},{j:e.t((null==(o=v.value)?void 0:o.name)||"选择车型"),k:e.o(e=>n.value=!0),l:v.value},v.value?e.e({m:e.n(g.value),n:Math.min(m.value,100)+"%",o:f.value+"%",p:e.t(v.value.minWeight.toLocaleString()),q:e.t(v.value.maxWeight.toLocaleString()),r:h.value,s:e.t(y.value),t:e.t(j.value.toLocaleString()),v:e.t(v.value.minWeight.toLocaleString()),w:e.t(v.value.maxWeight.toLocaleString()),x:e.n("truck-status--"+g.value),y:"insufficient"===g.value},"insufficient"===g.value?{z:e.t((v.value.minWeight-j.value).toLocaleString())}:"overload"===g.value?{B:e.t((j.value-v.value.maxWeight).toLocaleString())}:{},{A:"overload"===g.value}):{},{C:e.o(e=>s.value.driverPhone=e),D:e.p({label:"司机手机号（可选）",placeholder:"请输入司机手机号",type:"number",modelValue:s.value.driverPhone}),E:e.o(e=>s.value.promotionIds=e),F:e.p({options:M.value,multiple:!0,label:"",modelValue:s.value.promotionIds}),G:e.o(e=>s.value.images=e),H:e.p({label:"订单图片（可选）",tip:"可上传订单相关图片",modelValue:s.value.images}),I:e.t(P.value),J:e.t(j.value.toFixed(1)),K:e.t(N.value.toLocaleString()),L:E.value.length>0},E.value.length>0?{M:t._imports_0$6,N:e.f(E.value,(t,a,i)=>({a:e.t(t.name),b:e.f(t.gifts,(t,a,i)=>({a:e.t(t.productName),b:e.t(t.quantity),c:a})),c:a}))}:{},{O:_.value},_.value?e.e({P:e.t(_.value.name),Q:e.t(_.value.balance.toLocaleString()),R:_.value.balance<0?1:"",S:!A.value},(A.value,{}),{T:A.value?"":1}):{},{U:e.o(D),V:n.value},n.value?{W:e.f(u.value,(t,a,i)=>e.e({a:e.t(t.name),b:e.t(t.minWeight.toLocaleString()),c:e.t(t.maxWeight.toLocaleString()),d:t.isDefault},(t.isDefault,{}),{e:s.value.truckTypeId===t.id},(s.value.truckTypeId,t.id,{}),{f:t.id,g:s.value.truckTypeId===t.id?1:"",h:e.o(e=>{return a=t.id,s.value.truckTypeId=a,void(n.value=!1);var a},t.id)})),X:e.o(p),Y:e.o(e=>n.value=!1),Z:e.o(()=>{}),aa:e.o(e=>n.value=!1)}:{})}}}),l=e._export_sfc(n,[["__scopeId","data-v-e52995ca"]]);wx.createPage(l);
