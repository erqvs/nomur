"use strict";const e=require("../../../common/vendor.js"),a=require("../../../stores/app.js"),t=require("../../../api/index.js"),l=require("../../../utils/upload.js");Math||o();const o=()=>"../../../components/QuickInput/index.js",n=e.defineComponent({__name:"edit",setup(o){const n=a.useAppStore(),s=e.ref(""),r=e.computed(()=>!!s.value),u=e.ref({avatar:"",name:"",phone1:"",phone2:"",address:"",yearlyTargets:{}});e.ref([]);const i=e.ref([]),d=e.ref(0);e.onLoad(a=>{if(null==a?void 0:a.id){s.value=a.id,e.index.setNavigationBarTitle({title:"编辑代理"});const t=n.agents.find(e=>e.id===a.id);t&&(u.value={avatar:t.avatar||"",name:t.name,phone1:t.phone1,phone2:t.phone2||"",address:t.address,yearlyTargets:{...t.yearlyTargets}})}});const c=e=>{const a=n.products.find(a=>a.id===e);return(null==a?void 0:a.name)||e},v=e=>{for(const a of Object.keys(u.value.yearlyTargets)){const t=u.value.yearlyTargets[a];if("object"==typeof t&&null!==t&&"products"in t){const a=t;if(a.products&&a.products.includes(e))return!0}}return!1},p=e=>{for(const a of Object.keys(u.value.yearlyTargets))if(a.startsWith("_group_")){const t=u.value.yearlyTargets[a];if(t&&"object"==typeof t&&"products"in t&&t.products.includes(e))return a}return null},y=e=>{const a=u.value.yearlyTargets[e];return"number"==typeof a?a:0},g=(e,a)=>{p(e)&&w(e),u.value.yearlyTargets={...u.value.yearlyTargets,[e]:Math.max(0,a||0)}},h=(e,a)=>{const t=y(e);g(e,Math.max(0,t+a))},f=()=>{i.value=[],d.value=0},T=()=>{if(i.value.length>1){const e=x(i.value);if(e){return u.value.yearlyTargets[e].target}}return d.value},m=e=>{d.value=Math.max(0,d.value+e)},x=e=>{for(const a of Object.keys(u.value.yearlyTargets))if(a.startsWith("_group_")){const t=u.value.yearlyTargets[a];if(t&&"object"==typeof t&&"products"in t){const l=[...t.products].sort(),o=[...e].sort();if(l.length===o.length&&l.every((e,a)=>e===o[a]))return a}}return null},b=()=>{if(i.value.length<2)return void e.index.showToast({title:"请至少选择2个产品",icon:"none"});if(d.value<=0)return void e.index.showToast({title:"请输入组合目标",icon:"none"});i.value.forEach(e=>{"number"==typeof u.value.yearlyTargets[e]&&delete u.value.yearlyTargets[e]}),i.value.forEach(e=>{w(e)});const a=x(i.value)||`_group_${Date.now()}`;u.value.yearlyTargets={...u.value.yearlyTargets,[a]:{products:[...i.value],target:d.value}},e.index.showToast({title:"组合目标已保存",icon:"success"}),f()},w=e=>{const a=p(e);if(a){const t=u.value.yearlyTargets[a];if(t&&"object"==typeof t&&"products"in t){const l=t.products.filter(a=>a!==e);0===l.length?delete u.value.yearlyTargets[a]:1===l.length?(delete u.value.yearlyTargets[a],u.value.yearlyTargets[l[0]]=t.target):u.value.yearlyTargets[a]={products:l,target:t.target}}}},j=async()=>{e.index.chooseImage({count:1,sizeType:["compressed"],sourceType:["album","camera"],success:async a=>{try{const t=await l.uploadImage(a.tempFilePaths[0]);u.value.avatar=t,e.index.showToast({title:"头像上传成功",icon:"success"})}catch(t){e.index.showToast({title:t.message||"头像上传失败",icon:"none"})}}})},_=async()=>{if(u.value.name)if(u.value.phone1)if(/^1[3-9]\d{9}$/.test(u.value.phone1))if(!u.value.phone2||/^1[3-9]\d{9}$/.test(u.value.phone2))if(u.value.address)try{r.value?(await t.agentApi.update(s.value,u.value),await n.loadAgents(),e.index.showToast({title:"修改成功",icon:"success"})):(await n.addAgent(u.value),e.index.showToast({title:"添加成功",icon:"success"})),setTimeout(()=>{e.index.navigateBack()},1500)}catch(a){e.index.showToast({title:a.message||(r.value?"修改失败":"添加失败"),icon:"none"})}else e.index.showToast({title:"请输入地址",icon:"none"});else e.index.showToast({title:"请输入正确的备用手机号",icon:"none"});else e.index.showToast({title:"请输入正确的手机号",icon:"none"});else e.index.showToast({title:"请输入手机号",icon:"none"});else e.index.showToast({title:"请输入代理商姓名",icon:"none"})};return(a,t)=>e.e({a:u.value.avatar},u.value.avatar?{b:u.value.avatar}:{},{c:e.o(j),d:e.o(e=>u.value.name=e),e:e.p({label:"姓名",placeholder:"请输入代理商姓名",required:!0,modelValue:u.value.name}),f:e.o(e=>u.value.phone1=e),g:e.p({label:"手机号",placeholder:"请输入手机号",type:"number",required:!0,modelValue:u.value.phone1}),h:e.o(e=>u.value.phone2=e),i:e.p({label:"备用手机号（可选）",placeholder:"请输入备用手机号",type:"number",modelValue:u.value.phone2}),j:u.value.address,k:e.o(e=>u.value.address=e.detail.value),l:e.f(e.unref(n).products,(a,t,l)=>e.e({a:i.value.includes(a.id)},(i.value.includes(a.id),{}),{b:i.value.includes(a.id)?1:"",c:e.o(e=>(e=>{const a=i.value.indexOf(e);if(a>-1)i.value.splice(a,1);else{v(e)&&w(e),i.value.push(e);const a=p(e);if(a){const e=u.value.yearlyTargets[a];e&&"object"==typeof e&&"target"in e&&(d.value=e.target)}}})(a.id),a.id),d:e.t(a.name),e:!v(a.id)},v(a.id)?{}:{f:e.o(e=>h(a.id,-10),a.id),g:y(a.id),h:e.o(e=>{var t,l;return g(a.id,Number((null==(t=e.detail)?void 0:t.value)??(null==(l=e.target)?void 0:l.value)??0))},a.id),i:e.o(e=>h(a.id,10),a.id),j:e.o(()=>{},a.id)},{k:a.id,l:v(a.id)?1:""})),m:i.value.length>1},i.value.length>1?{n:e.t(i.value.length),o:e.f(i.value,(a,t,l)=>e.e({a:e.t(c(a)),b:t<i.value.length-1},(i.value.length,{}),{c:a})),p:e.o(e=>m(-1e3)),q:T(),r:e.o(e=>{var a,t,l;return l=Number((null==(a=e.detail)?void 0:a.value)??(null==(t=e.target)?void 0:t.value)??0),void(d.value=Math.max(0,l||0))}),s:e.o(e=>m(1e3)),t:e.o(f),v:e.o(b)}:{},{w:e.t(r.value?"保存修改":"添加代理"),x:e.o(_)})}}),s=e._export_sfc(n,[["__scopeId","data-v-0eb05ffc"]]);wx.createPage(s);
