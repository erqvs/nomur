"use strict";const e=require("../../../common/vendor.js"),a=require("../../../common/assets.js"),t=require("../../../stores/app.js"),o=require("../../../api/index.js");Math||(n+u+l+r)();const n=()=>"../../../components/BalanceCard/index.js",u=()=>"../../../components/TagSelect/index.js",l=()=>"../../../components/QuickInput/index.js",r=()=>"../../../components/ImageUploader/index.js",i=e.defineComponent({__name:"detail",setup(n){const u=t.useAppStore(),l=e.ref(""),r=e.computed(()=>u.agents.find(e=>e.id===l.value)),i=e.ref(null),s=e.computed(()=>{if(!l.value)return[];return[...u.getAgentTransactions(l.value).map(e=>({type:"transaction",id:e.id,reason:e.reason,amount:e.amount,paymentAccountName:e.paymentAccountName,remark:e.remark,createdAt:e.createdAt})),...u.getAgentOrders(l.value).map(e=>({type:"order",id:e.id,items:e.items,totalAmount:e.totalAmount,remark:e.remark,createdAt:e.createdAt}))].sort((e,a)=>new Date(a.createdAt).getTime()-new Date(e.createdAt).getTime()).slice(0,10)}),d=e=>{const a=u.products.find(a=>a.id===e);return(null==a?void 0:a.name)||e},v=(e,a)=>{if(a.isGroup){if(a.productNames)return a.productNames;if(a.products&&Array.isArray(a.products))return a.products.map(e=>d(e)).join(" + ");if(e.startsWith("_group_")||e.startsWith("group_")){const a=u.agents.find(e=>e.id===l.value);if(a&&a.yearlyTargets){const t=a.yearlyTargets[e];if(t&&"object"==typeof t&&"products"in t){const e=t.products;if(Array.isArray(e))return e.map(e=>d(e)).join(" + ")}}}return e}return d(e)},c=e.ref(!1),p=e.ref(!1),m=e.ref(!1),g=e.ref(!1),y=e.ref({agentId:null,reason:"payment",amount:0,proof:[],remark:"",paymentAccountId:null}),h=e.ref([]),f=e.computed(()=>h.value.map(e=>({label:e.name,value:e.id}))),I=e.ref({agentId:null,reason:"shipping",amount:0,otherReason:"",productId:null,quantity:0,remark:""}),A=e.ref({fromAgentId:null,toAgentId:null,productId:null,quantity:0,discount:0}),x=e.ref({productType:"productA",quantity:0,saleDate:"",remark:""}),w=e.computed(()=>u.agents.map(e=>({label:e.name,value:e.id,subLabel:`¥${e.balance.toLocaleString()}`}))),T=e=>{A.value.quantity=Math.max(1,A.value.quantity+e)},k=e.computed(()=>{if(!A.value.productId)return 0;const e=u.products.find(e=>e.id===A.value.productId);return(null==e?void 0:e.price)||0}),q=e.computed(()=>k.value*A.value.quantity),b=e.computed(()=>{const e=q.value-(A.value.discount||0);return Math.max(0,e)}),$=e=>{y.value.reason=e},_=e=>{I.value.reason=e,"other"!==e&&(I.value.otherReason="")},S=e=>{I.value.quantity=Math.max(1,I.value.quantity+e)},N=async()=>{if(y.value.agentId)if(y.value.amount)if("payment"!==y.value.reason||y.value.paymentAccountId)try{const a="other"===y.value.reason?"gift":y.value.reason;await u.recharge(y.value.agentId,y.value.amount,a,y.value.proof.length>0?y.value.proof[0]:void 0,y.value.remark||void 0,y.value.paymentAccountId||void 0),e.index.showToast({title:"充值成功",icon:"success"}),c.value=!1,y.value={agentId:null,reason:"payment",amount:0,proof:[],remark:"",paymentAccountId:null}}catch(a){e.index.showToast({title:a.message||"充值失败",icon:"none"})}else e.index.showToast({title:"请选择收款账户",icon:"none"});else e.index.showToast({title:"请输入金额",icon:"none"});else e.index.showToast({title:"请选择代理",icon:"none"})},j=async()=>{if(I.value.agentId)if(I.value.amount)if("other"!==I.value.reason||I.value.otherReason)try{const a="other"===I.value.reason?"fine":I.value.reason;let t="";"other"===I.value.reason&&I.value.otherReason&&(t=I.value.otherReason),I.value.remark&&(t=t?`${t}；${I.value.remark}`:I.value.remark),await u.deduct(I.value.agentId,I.value.amount,a,t||void 0,I.value.productId||void 0,I.value.quantity||void 0),e.index.showToast({title:"扣款成功",icon:"success"}),p.value=!1,I.value={agentId:null,reason:"shipping",amount:0,otherReason:"",productId:null,quantity:0,remark:""}}catch(a){e.index.showToast({title:a.message||"扣款失败",icon:"none"})}else e.index.showToast({title:"请输入扣款原因",icon:"none"});else e.index.showToast({title:"请输入金额",icon:"none"});else e.index.showToast({title:"请选择代理",icon:"none"})},D=async()=>{if(!x.value.quantity||x.value.quantity<=0)e.index.showToast({title:"请输入数量",icon:"none"});else if(l.value)try{await o.supplementApi.create(l.value,{productType:x.value.productType,quantity:x.value.quantity,saleDate:x.value.saleDate||void 0,remark:x.value.remark||void 0}),e.index.showToast({title:"补充数据成功",icon:"success"}),g.value=!1,x.value={productType:"productA",quantity:0,saleDate:"",remark:""},await Promise.all([u.loadAgents(),u.loadOrders()])}catch(a){e.index.showToast({title:a.message||"补充数据失败",icon:"none"})}else e.index.showToast({title:"代理信息错误",icon:"none"})},M=async()=>{if(A.value.fromAgentId&&A.value.toAgentId)if(A.value.fromAgentId!==A.value.toAgentId)if(A.value.productId)if(!A.value.quantity||A.value.quantity<=0)e.index.showToast({title:"请输入数量",icon:"none"});else if(b.value<=0)e.index.showToast({title:"调货金额必须大于0",icon:"none"});else try{await u.transfer(A.value.fromAgentId,A.value.toAgentId,b.value,A.value.productId||void 0,A.value.quantity||void 0),e.index.showToast({title:"调货成功",icon:"success"}),m.value=!1,A.value={fromAgentId:null,toAgentId:null,productId:null,quantity:0,discount:0}}catch(a){e.index.showToast({title:a.message||"调货失败",icon:"none"})}else e.index.showToast({title:"请选择产品",icon:"none"});else e.index.showToast({title:"发货方和收货方不能相同",icon:"none"});else e.index.showToast({title:"请选择双方代理",icon:"none"})},V=async()=>{if(l.value)try{const e=await o.agentApi.getStatistics(l.value);i.value={yearlyStats:e.yearlyStats||{}}}catch(e){console.error("加载统计数据失败:",e)}};e.onLoad(async a=>{var t;(null==a?void 0:a.id)&&(l.value=a.id,e.index.setNavigationBarTitle({title:(null==(t=r.value)?void 0:t.name)||"代理详情"}),await Promise.all([u.loadOrders(),u.loadTransactions()]),await V())}),e.onShow(async()=>{var a;l.value&&(await Promise.all([u.loadAgents(),u.loadOrders(),u.loadTransactions()]),await V(),e.index.setNavigationBarTitle({title:(null==(a=r.value)?void 0:a.name)||"代理详情"}))});const F=a=>{e.index.makePhoneCall({phoneNumber:a})},R=e=>({gift:"赠送",payment:"打款充值",shipping:"发货扣款",fine:"罚款",transfer_in:"调货收入",transfer_out:"调货支出",marketing:"营销退款"}[e]||"其他"),L=e=>{const a=new Date(e),t=new Date,o=new Date(t.getFullYear(),t.getMonth(),t.getDate()),n=new Date(a.getFullYear(),a.getMonth(),a.getDate()),u=Math.floor((o.getTime()-n.getTime())/864e5),l=String(a.getMonth()+1).padStart(2,"0"),r=String(a.getDate()).padStart(2,"0"),i=String(a.getHours()).padStart(2,"0"),s=String(a.getMinutes()).padStart(2,"0");if(0===u)return`${i}:${s}`;if(1===u)return`昨天 ${i}:${s}`;if(u<7)return`${l}-${r} ${i}:${s}`;if(a.getFullYear()===t.getFullYear())return`${l}-${r} ${i}:${s}`;return`${a.getFullYear()}-${l}-${r} ${i}:${s}`},O=async()=>{y.value.agentId=l.value,await(async()=>{try{const e=await o.paymentAccountApi.getAll();if(!Array.isArray(e))return console.error("收款账户数据格式错误:",e),void(h.value=[]);h.value=e}catch(e){console.error("加载收款账户失败:",e),h.value=[]}})(),c.value=!0},C=()=>{I.value.agentId=l.value,p.value=!0},P=()=>{A.value.fromAgentId=l.value,m.value=!0},B=()=>{e.index.navigateTo({url:`/pages/admin/agents/edit?id=${l.value}`})},Y=()=>{e.index.navigateTo({url:`/pages/admin/orders/list?agentId=${l.value}`})},Q=()=>{r.value&&e.index.showModal({title:"删除代理",content:`确定要删除代理"${r.value.name}"吗？\n\n注意：如果该代理存在订单或交易记录，将无法删除。`,confirmText:"删除",confirmColor:"#FF4D4F",success:async a=>{if(a.confirm)try{await o.agentApi.delete(l.value),await u.loadAgents(),e.index.showToast({title:"删除成功",icon:"success"}),setTimeout(()=>{e.index.navigateBack()},1500)}catch(t){e.index.showToast({title:t.message||"删除失败",icon:"none"})}}})};return(t,o)=>e.e({a:r.value},r.value?e.e({b:a._imports_1$6,c:e.o(Q),d:r.value.avatar||"/static/images/default-avatar.svg",e:e.t(r.value.name),f:a._imports_1$5,g:e.t(r.value.phone1),h:e.o(e=>F(r.value.phone1)),i:r.value.phone2},r.value.phone2?{j:a._imports_1$5,k:e.t(r.value.phone2),l:e.o(e=>F(r.value.phone2))}:{},{m:a._imports_4,n:e.t(r.value.address),o:e.p({balance:r.value.balance,subInfo:`更新于 ${r.value.updatedAt.slice(0,10)}`}),p:i.value&&i.value.yearlyStats},i.value&&i.value.yearlyStats?e.e({q:e.f(i.value.yearlyStats,(a,t,o)=>({a:e.t(v(t,a)),b:e.t(a.completed),c:e.t(a.target),d:a.percentage+"%",e:e.t(a.percentage),f:t})),r:0===Object.keys(i.value.yearlyStats).length},(Object.keys(i.value.yearlyStats).length,{})):{},{s:a._imports_1$7,t:e.o(O),v:a._imports_1$4,w:e.o(C),x:a._imports_2$1,y:e.o(P),z:a._imports_0$5,A:e.o(B),B:a._imports_1$2,C:e.o(Y),D:e.f(s.value,(a,t,o)=>{return e.e({a:"order"===a.type?"/static/icons/box.svg":(n=a.reason,{gift:"/static/icons/gift.svg",payment:"/static/icons/credit-card.svg",shipping:"/static/icons/box.svg",fine:"/static/icons/warning.svg",transfer_in:"/static/icons/arrow-down-circle.svg",transfer_out:"/static/icons/arrow-up-circle.svg",marketing:"/static/icons/target.svg"}[n]||"/static/icons/money.svg"),b:e.t("order"===a.type?"订单":R(a.reason)),c:"transaction"===a.type&&"payment"===a.reason&&a.paymentAccountName},"transaction"===a.type&&"payment"===a.reason&&a.paymentAccountName?{d:e.t(a.paymentAccountName)}:{},{e:"order"===a.type&&a.items&&a.items.length>0},"order"===a.type&&a.items&&a.items.length>0?{f:e.f(a.items,(a,t,o)=>({a:e.t(a.productName),b:e.t(a.quantity),c:t}))}:{},{g:e.t(L(a.createdAt)),h:a.remark},a.remark?{i:e.t(a.remark)}:{},{j:"transaction"===a.type},"transaction"===a.type?{k:e.t(a.amount>0?"+":""),l:e.t(a.amount.toLocaleString()),m:a.amount>0?1:"",n:a.amount<0?1:""}:{o:e.t(a.totalAmount.toLocaleString())},{p:"order"===a.type?`order-${a.id}`:`tx-${a.id}`});var n}),E:0===s.value.length},(s.value.length,{}),{F:c.value},c.value?e.e({G:e.o(e=>y.value.agentId=e),H:e.p({options:w.value,compact:!0,modelValue:y.value.agentId}),I:"payment"===y.value.reason?1:"",J:e.o(e=>$("payment")),K:"freight"===y.value.reason?1:"",L:e.o(e=>$("freight")),M:"other"===y.value.reason?1:"",N:e.o(e=>$("other")),O:"payment"===y.value.reason},"payment"===y.value.reason?{P:e.o(e=>y.value.paymentAccountId=e),Q:e.p({options:f.value,compact:!0,modelValue:y.value.paymentAccountId})}:{},{R:y.value.remark,S:e.o(e=>y.value.remark=e.detail.value),T:e.o(e=>y.value.amount=e),U:e.p({label:"充值金额",type:"digit",prefix:"¥",showQuickNumbers:!0,quickNumbers:[1e3,5e3,1e4,5e4],modelValue:y.value.amount}),V:e.o(e=>y.value.proof=e),W:e.p({label:"上传凭证",maxCount:1,addText:"上传凭证",modelValue:y.value.proof}),X:e.o(e=>c.value=!1),Y:e.o(N),Z:e.o(()=>{}),aa:e.o(e=>c.value=!1)}):{},{ab:p.value},p.value?e.e({ac:e.o(e=>I.value.agentId=e),ad:e.p({options:w.value,compact:!0,modelValue:I.value.agentId}),ae:"shipping"===I.value.reason?1:"",af:e.o(e=>_("shipping")),ag:"other"===I.value.reason?1:"",ah:e.o(e=>_("other")),ai:"other"===I.value.reason},"other"===I.value.reason?{aj:I.value.otherReason,ak:e.o(e=>I.value.otherReason=e.detail.value)}:{},{al:e.f(e.unref(u).products,(a,t,o)=>e.e({a:I.value.productId===a.id},(I.value.productId,a.id,{}),{b:e.t(a.name),c:e.o(t=>{return o=a.id,e.index.vibrateShort({type:"light"}),void(I.value.productId===o?(I.value.productId=null,I.value.quantity=0):(I.value.productId=o,I.value.quantity=I.value.quantity||1));var o},a.id),d:I.value.productId===a.id},I.value.productId===a.id?{e:e.o(e=>S(-1),a.id),f:I.value.quantity,g:e.o(e=>{var a,t,o;return o=Number((null==(a=e.detail)?void 0:a.value)??(null==(t=e.target)?void 0:t.value)??0),void(I.value.quantity=Math.max(1,o||1))},a.id),h:e.o(e=>S(1),a.id),i:e.o(()=>{},a.id)}:{},{j:a.id,k:I.value.productId===a.id?1:""})),am:I.value.remark,an:e.o(e=>I.value.remark=e.detail.value),ao:e.o(e=>I.value.amount=e),ap:e.p({label:"扣款金额",type:"digit",prefix:"¥",showQuickNumbers:!0,quickNumbers:[100,500,1e3,5e3],modelValue:I.value.amount}),aq:e.o(e=>p.value=!1),ar:e.o(j),as:e.o(()=>{}),at:e.o(e=>p.value=!1)}):{},{av:m.value},m.value?{aw:e.o(e=>A.value.fromAgentId=e),ax:e.p({options:w.value,compact:!0,modelValue:A.value.fromAgentId}),ay:e.o(e=>A.value.toAgentId=e),az:e.p({options:w.value,compact:!0,modelValue:A.value.toAgentId}),aA:e.f(e.unref(u).products,(a,t,o)=>e.e({a:A.value.productId===a.id},(A.value.productId,a.id,{}),{b:e.t(a.name),c:e.o(t=>{return o=a.id,e.index.vibrateShort({type:"light"}),void(A.value.productId===o?(A.value.productId=null,A.value.quantity=0):(A.value.productId=o,A.value.quantity=A.value.quantity||10));var o},a.id),d:A.value.productId===a.id},A.value.productId===a.id?{e:e.o(e=>T(-1),a.id),f:A.value.quantity,g:e.o(e=>{var a,t,o;return o=Number((null==(a=e.detail)?void 0:a.value)??(null==(t=e.target)?void 0:t.value)??0),void(A.value.quantity=Math.max(1,o||1))},a.id),h:e.o(e=>T(1),a.id),i:e.o(()=>{},a.id)}:{},{j:a.id,k:A.value.productId===a.id?1:""})),aB:e.o(e=>A.value.discount=e),aC:e.p({label:"优惠金额（可选）",type:"digit",prefix:"¥",placeholder:"0",modelValue:A.value.discount}),aD:e.t(b.value.toLocaleString()),aE:e.t(b.value.toLocaleString()),aF:e.o(e=>m.value=!1),aG:e.o(M),aH:e.o(()=>{}),aI:e.o(e=>m.value=!1)}:{},{aJ:g.value},g.value?{aK:"productA"===x.value.productType?1:"",aL:e.o(e=>x.value.productType="productA"),aM:"mixed"===x.value.productType?1:"",aN:e.o(e=>x.value.productType="mixed"),aO:e.o(e=>x.value.quantity=e),aP:e.p({label:"数量（箱）",type:"number",placeholder:"请输入数量",required:!0,modelValue:x.value.quantity}),aQ:x.value.saleDate,aR:e.o(e=>x.value.saleDate=e.detail.value),aS:x.value.remark,aT:e.o(e=>x.value.remark=e.detail.value),aU:e.o(e=>g.value=!1),aV:e.o(D),aW:e.o(()=>{}),aX:e.o(e=>g.value=!1)}:{}):{})}}),s=e._export_sfc(i,[["__scopeId","data-v-15082127"]]);wx.createPage(s);
