"use strict";const e=require("../../../common/vendor.js"),t=require("../../../common/assets.js"),a=require("../../../stores/app.js"),n=require("../../../api/index.js");Math||(o+u+i)();const o=()=>"../../../components/TagSelect/index.js",u=()=>"../../../components/QuickInput/index.js",i=()=>"../../../components/ImageUploader/index.js",l=e.defineComponent({__name:"index",setup(o){const u=a.useAppStore(),i=[{label:"全部",value:"all"},{label:"充值",value:"recharge"},{label:"扣款",value:"deduct"},{label:"调货",value:"transfer"}],l=e.ref("all"),r=e.computed(()=>"all"===l.value?u.transactions:"transfer"===l.value?u.transactions.filter(e=>"transfer_in"===e.reason||"transfer_out"===e.reason):u.transactions.filter(e=>e.type===l.value)),s=e.computed(()=>u.agents.map(e=>({label:e.name,value:e.id,subLabel:`¥${e.balance.toLocaleString()}`}))),d=e.ref(!1),c=e.ref(!1),v=e.ref(!1),p=e.ref({agentId:null,reason:"payment",amount:0,proof:[],remark:"",paymentAccountId:null}),m=e.ref([]),g=e.computed(()=>{const e={};return u.products.forEach(t=>{let a="其他";t.name.includes("芒果")?a="芒果类":t.name.includes("茶")?a="茶类":(t.name.includes("龙眼")||t.name.includes("水果"))&&(a="水果类"),e[a]||(e[a]={type:a,products:[]}),e[a].products.push(t)}),Object.values(e)}),f=e=>m.value.some(t=>t.type===e),h=e=>{const t=m.value.find(t=>t.type===e);return(null==t?void 0:t.quantity)||0},y=(e,t)=>{const a=m.value.find(t=>t.type===e);a&&(a.quantity=Math.max(1,a.quantity+t))},I=e.ref([]),x=e.computed(()=>Array.isArray(I.value)?I.value.map(e=>({label:e.name,value:e.id})):[]);e.onMounted(()=>{(async()=>{try{const e=await n.paymentAccountApi.getAll();if(!Array.isArray(e))return void(I.value=[]);I.value=e.map(e=>({id:e.id,name:e.name,balance:0}))}catch(e){console.error("加载收款账户失败:",e),I.value=[]}})()});const w=e=>{p.value.reason=e,"other"!==e&&(m.value=[])},A=e.ref({agentId:null,reason:"shipping",items:[],amount:0,remark:""}),b=e=>{A.value.reason=e,"other"!==e&&(A.value.remark=""),"other"===e&&(A.value.items=[])},q=e=>A.value.items.some(t=>t.productId===e),k=e=>{const t=A.value.items.find(t=>t.productId===e);return(null==t?void 0:t.quantity)||0},T=(e,t)=>{const a=A.value.items.find(t=>t.productId===e);a&&(a.quantity=Math.max(1,a.quantity+t),$())},$=()=>{const e=A.value.items.reduce((e,t)=>{const a=u.products.find(e=>e.id===t.productId);return a?e+a.price*t.quantity:e},0);A.value.amount=e},N=e.ref({fromAgentId:null,toAgentId:null,items:[],discount:0,remark:""}),_=e=>N.value.items.some(t=>t.productId===e),M=e=>{const t=N.value.items.find(t=>t.productId===e);return(null==t?void 0:t.quantity)||0},S=(e,t)=>{const a=N.value.items.find(t=>t.productId===e);a&&(a.quantity=Math.max(1,a.quantity+t))},j=e.computed(()=>N.value.items.reduce((e,t)=>{const a=u.products.find(e=>e.id===t.productId);return a?e+a.price*t.quantity:e},0)),V=e.computed(()=>{const e=j.value-(N.value.discount||0);return Math.max(0,e)}),D=e=>({gift:"赠送",payment:"打款充值",freight:"运费",shipping:"发货扣款",fine:"罚款",transfer_in:"调货收入",transfer_out:"调货支出",marketing:"营销退款"}[e]),L=e=>{const t=new Date(e),a=new Date,n=new Date(a.getFullYear(),a.getMonth(),a.getDate()),o=new Date(t.getFullYear(),t.getMonth(),t.getDate()),u=Math.floor((n.getTime()-o.getTime())/864e5),i=String(t.getMonth()+1).padStart(2,"0"),l=String(t.getDate()).padStart(2,"0"),r=String(t.getHours()).padStart(2,"0"),s=String(t.getMinutes()).padStart(2,"0");if(0===u)return`${r}:${s}`;if(1===u)return`昨天 ${r}:${s}`;if(u<7)return`${i}-${l} ${r}:${s}`;if(t.getFullYear()===a.getFullYear())return`${i}-${l} ${r}:${s}`;return`${t.getFullYear()}-${i}-${l} ${r}:${s}`},F=e.ref(!1);e.ref("");const E=e.ref(""),Y=e.ref([]),C=e.ref(!1);e.ref("");const O=e.ref(""),Q=e.ref([]),H=async()=>{if(p.value.agentId)if(p.value.amount||0!==m.value.length)if("payment"!==p.value.reason||p.value.paymentAccountId)try{const t="other"===p.value.reason?"gift":p.value.reason;if(p.value.amount>0&&await u.recharge(p.value.agentId,p.value.amount,t,p.value.proof[0],p.value.remark||void 0,p.value.paymentAccountId||void 0),m.value.length>0){const e=u.agents.find(e=>e.id===p.value.agentId);if(!e)throw new Error("代理不存在");const t=[];if(m.value.forEach(e=>{if(0===e.productIds.length)return;const a=u.products.filter(t=>e.productIds.includes(t.id));if(0===a.length)return;let n=e.quantity;const o={};for(;n>0;){const e=a[Math.floor(Math.random()*a.length)],t=Math.min(n,Math.floor(Math.random()*n)+1);o[e.id]=(o[e.id]||0)+t,n-=t}Object.entries(o).forEach(([e,a])=>{const n=u.products.find(t=>t.id===e);if(n){const o=t.find(t=>t.productId===e);o?o.quantity+=a:t.push({productId:n.id,productName:n.name,quantity:a,price:n.price,weight:n.weight})}})}),t.length>0){const a=t.reduce((e,t)=>e+t.quantity*t.weight,0),n=t.reduce((e,t)=>e+t.quantity*t.price,0);await u.createOrder({agentId:p.value.agentId,agentName:e.name,items:t,totalWeight:a,totalAmount:n,images:p.value.proof.length>0?p.value.proof:void 0})}}e.index.showToast({title:"操作成功",icon:"success"}),d.value=!1,p.value={agentId:null,reason:"payment",amount:0,proof:[],remark:"",paymentAccountId:null},m.value=[]}catch(t){e.index.showToast({title:t.message||"操作失败",icon:"none"})}else e.index.showToast({title:"请选择收款账户",icon:"none"});else e.index.showToast({title:"请输入金额或选择赠送产品",icon:"none"});else e.index.showToast({title:"请选择代理",icon:"none"})},z=async()=>{if(A.value.agentId){if("shipping"===A.value.reason){if(0===A.value.items.length)return void e.index.showToast({title:"请至少选择一个产品",icon:"none"});for(const t of A.value.items)if(!t.quantity||t.quantity<=0)return void e.index.showToast({title:"请设置所有产品的数量",icon:"none"})}if(!A.value.amount||A.value.amount<=0)e.index.showToast({title:"请输入金额",icon:"none"});else if("other"!==A.value.reason||A.value.remark)try{const t="other"===A.value.reason?"shipping":A.value.reason,a="other"===A.value.reason?A.value.remark:A.value.remark||void 0,n="shipping"===A.value.reason&&A.value.items.length>0?A.value.items.map(e=>{const t=u.products.find(t=>t.id===e.productId);return{productId:e.productId,productName:(null==t?void 0:t.name)||"",quantity:e.quantity,price:(null==t?void 0:t.price)||0,weight:(null==t?void 0:t.weight)||0}}):void 0;await u.deduct(A.value.agentId,A.value.amount,t,a,n),e.index.showToast({title:"扣款成功",icon:"success"}),c.value=!1,A.value={agentId:null,reason:"shipping",items:[],amount:0,remark:""}}catch(t){e.index.showToast({title:t.message||"扣款失败",icon:"none"})}else e.index.showToast({title:"请输入扣款原因",icon:"none"})}else e.index.showToast({title:"请选择代理",icon:"none"})},B=()=>{},G=async()=>{if(N.value.fromAgentId&&N.value.toAgentId)if(N.value.fromAgentId!==N.value.toAgentId)if(0!==N.value.items.length){for(const t of N.value.items)if(!t.quantity||t.quantity<=0)return void e.index.showToast({title:"请设置所有产品的数量",icon:"none"});if(V.value<=0)e.index.showToast({title:"调货金额必须大于0",icon:"none"});else try{const t=N.value.items.map(e=>{const t=u.products.find(t=>t.id===e.productId);return{productId:e.productId,productName:(null==t?void 0:t.name)||"",quantity:e.quantity,price:(null==t?void 0:t.price)||0,weight:(null==t?void 0:t.weight)||0}});await u.transfer(N.value.fromAgentId,N.value.toAgentId,V.value,t,N.value.remark||void 0),e.index.showToast({title:"调货成功",icon:"success"}),v.value=!1,N.value={fromAgentId:null,toAgentId:null,items:[],discount:0,remark:""}}catch(t){e.index.showToast({title:t.message||"调货失败",icon:"none"})}}else e.index.showToast({title:"请至少选择一个产品",icon:"none"});else e.index.showToast({title:"发货方和收货方不能相同",icon:"none"});else e.index.showToast({title:"请选择双方代理",icon:"none"})};return(a,n)=>e.e({a:t._imports_0$3,b:e.o(e=>d.value=!0),c:t._imports_1$4,d:e.o(e=>c.value=!0),e:t._imports_2$1,f:e.o(e=>v.value=!0),g:e.f(i,(t,a,n)=>({a:e.t(t.label),b:t.value,c:l.value===t.value?1:"",d:e.o(e=>l.value=t.value,t.value)})),h:e.f(r.value,(a,n,o)=>{return e.e({a:(u=a.reason,{gift:"/static/icons/gift.svg",payment:"/static/icons/credit-card.svg",freight:"/static/icons/truck.svg",shipping:"/static/icons/box.svg",fine:"/static/icons/warning.svg",transfer_in:"/static/icons/arrow-down-circle.svg",transfer_out:"/static/icons/arrow-up-circle.svg",marketing:"/static/icons/target.svg"}[u]),b:e.t(a.agentName),c:e.o(t=>{return n=a.agentId,void e.index.navigateTo({url:`/pages/admin/agents/detail?id=${n}`});var n},a.id),d:e.t(D(a.reason)),e:"recharge"===a.type&&"payment"===a.reason&&a.paymentAccountName},"recharge"===a.type&&"payment"===a.reason&&a.paymentAccountName?{f:e.t(a.paymentAccountName),g:e.o(t=>(async()=>{e.index.switchTab({url:"/pages/admin/payees/index"})})(a.paymentAccountId,a.paymentAccountName),a.id)}:{},{h:"shipping"===a.reason&&a.orderItems&&a.orderItems.length>0},"shipping"===a.reason&&a.orderItems&&a.orderItems.length>0?{i:e.f(a.orderItems,(t,a,n)=>({a:e.t(t.productName),b:e.t(t.quantity),c:a}))}:{},{j:e.t(a.amount>0?"+":""),k:e.t(Math.abs(a.amount).toLocaleString()),l:a.amount>0?1:"",m:a.amount<0?1:"",n:a.proof},a.proof?{o:a.proof,p:t._imports_3,q:e.o(t=>{return n=a.proof,void e.index.previewImage({urls:[n]});var n},a.id)}:{},{r:e.t(L(a.createdAt)),s:a.id});var u}),i:0===r.value.length},0===r.value.length?{j:t._imports_0$5}:{},{k:d.value},d.value?e.e({l:e.o(e=>p.value.agentId=e),m:e.p({options:s.value,compact:!0,modelValue:p.value.agentId}),n:"payment"===p.value.reason?1:"",o:e.o(e=>w("payment")),p:"freight"===p.value.reason?1:"",q:e.o(e=>w("freight")),r:"other"===p.value.reason?1:"",s:e.o(e=>w("other")),t:"payment"===p.value.reason},"payment"===p.value.reason?{v:e.o(e=>p.value.paymentAccountId=e),w:e.p({options:x.value,compact:!0,modelValue:p.value.paymentAccountId})}:{},{x:"other"===p.value.reason},"other"===p.value.reason?{y:e.f(g.value,(t,a,n)=>e.e({a:f(t.type)},(f(t.type),{}),{b:e.t(t.type),c:e.t(t.products.map(e=>e.name).join("、")),d:e.o(a=>(t=>{e.index.vibrateShort({type:"light"});const a=m.value.findIndex(e=>e.type===t);if(a>-1)m.value.splice(a,1);else{const e=g.value.find(e=>e.type===t);e&&m.value.push({type:t,quantity:1,productIds:e.products.map(e=>e.id)})}})(t.type),t.type),e:f(t.type)},f(t.type)?{f:e.o(e=>y(t.type,-1),t.type),g:h(t.type),h:e.o(e=>{var a,n;return((e,t)=>{const a=m.value.find(t=>t.type===e);a&&(a.quantity=Math.max(1,t||1))})(t.type,Number((null==(a=e.detail)?void 0:a.value)??(null==(n=e.target)?void 0:n.value)??0))},t.type),i:e.o(e=>y(t.type,1),t.type),j:e.o(B,t.type)}:{},{k:t.type,l:f(t.type)?1:""}))}:{},{z:e.t("other"===p.value.reason?"充值原因":"备注（可选）"),A:"other"===p.value.reason?"请输入充值原因":"请输入备注信息",B:p.value.remark,C:e.o(e=>p.value.remark=e.detail.value),D:e.o(e=>p.value.amount=e),E:e.p({label:"充值金额",type:"digit",prefix:"¥",showQuickNumbers:!0,quickNumbers:[1e3,5e3,1e4,5e4],modelValue:p.value.amount}),F:e.o(e=>p.value.proof=e),G:e.p({label:"上传凭证",maxCount:1,addText:"上传凭证",modelValue:p.value.proof}),H:e.o(e=>d.value=!1),I:e.o(H),J:e.o(B),K:e.o(e=>d.value=!1)}):{},{L:c.value},c.value?e.e({M:e.o(e=>A.value.agentId=e),N:e.p({options:s.value,compact:!0,modelValue:A.value.agentId}),O:"shipping"===A.value.reason?1:"",P:e.o(e=>b("shipping")),Q:"other"===A.value.reason?1:"",R:e.o(e=>b("other")),S:"shipping"===A.value.reason},"shipping"===A.value.reason?{T:e.f(e.unref(u).products,(t,a,n)=>e.e({a:q(t.id)},(q(t.id),{}),{b:e.t(t.name),c:e.o(a=>(t=>{e.index.vibrateShort({type:"light"});const a=A.value.items.findIndex(e=>e.productId===t);a>-1?A.value.items.splice(a,1):A.value.items.push({productId:t,quantity:10}),$()})(t.id),t.id),d:q(t.id)},q(t.id)?{e:e.o(e=>T(t.id,-1),t.id),f:k(t.id),g:e.o(e=>{var a,n;return((e,t)=>{const a=A.value.items.find(t=>t.productId===e);a&&(a.quantity=Math.max(1,t||1),$())})(t.id,Number((null==(a=e.detail)?void 0:a.value)??(null==(n=e.target)?void 0:n.value)??0))},t.id),h:e.o(e=>T(t.id,1),t.id),i:e.o(B,t.id)}:{},{j:t.id,k:q(t.id)?1:""}))}:{},{U:e.t("other"===A.value.reason?"扣款原因":"备注（可选）"),V:"other"===A.value.reason?"请输入扣款原因":"请输入备注信息",W:A.value.remark,X:e.o(e=>A.value.remark=e.detail.value),Y:e.o(e=>A.value.amount=e),Z:e.p({label:"扣款金额",type:"digit",prefix:"¥",showQuickNumbers:"shipping"!==A.value.reason,quickNumbers:[100,500,1e3,5e3],disabled:"shipping"===A.value.reason,modelValue:A.value.amount}),aa:e.o(e=>c.value=!1),ab:e.o(z),ac:e.o(B),ad:e.o(e=>c.value=!1)}):{},{ae:v.value},v.value?{af:e.o(e=>N.value.fromAgentId=e),ag:e.p({options:s.value,compact:!0,modelValue:N.value.fromAgentId}),ah:e.o(e=>N.value.toAgentId=e),ai:e.p({options:s.value,compact:!0,modelValue:N.value.toAgentId}),aj:e.f(e.unref(u).products,(t,a,n)=>e.e({a:_(t.id)},(_(t.id),{}),{b:e.t(t.name),c:e.o(a=>(t=>{e.index.vibrateShort({type:"light"});const a=N.value.items.findIndex(e=>e.productId===t);a>-1?N.value.items.splice(a,1):N.value.items.push({productId:t,quantity:10})})(t.id),t.id),d:_(t.id)},_(t.id)?{e:e.o(e=>S(t.id,-1),t.id),f:M(t.id),g:e.o(e=>{var a,n;return((e,t)=>{const a=N.value.items.find(t=>t.productId===e);a&&(a.quantity=Math.max(1,t||1))})(t.id,Number((null==(a=e.detail)?void 0:a.value)??(null==(n=e.target)?void 0:n.value)??0))},t.id),h:e.o(e=>S(t.id,1),t.id),i:e.o(B,t.id)}:{},{j:t.id,k:_(t.id)?1:""})),ak:e.o(e=>N.value.discount=e),al:e.p({label:"优惠金额（可选）",type:"digit",prefix:"¥",placeholder:"0",modelValue:N.value.discount}),am:e.t(V.value.toLocaleString()),an:e.t(V.value.toLocaleString()),ao:N.value.remark,ap:e.o(e=>N.value.remark=e.detail.value),aq:e.o(e=>v.value=!1),ar:e.o(G),as:e.o(B),at:e.o(e=>v.value=!1)}:{},{av:F.value},F.value?e.e({aw:e.t(E.value),ax:e.f(Y.value,(t,a,n)=>e.e({a:e.t(L(t.createdAt)),b:e.t(t.amount.toLocaleString()),c:t.paymentAccountName},t.paymentAccountName?{d:e.t(t.paymentAccountName)}:{},{e:t.id})),ay:0===Y.value.length},(Y.value.length,{}),{az:e.o(e=>F.value=!1),aA:e.o(B),aB:e.o(e=>F.value=!1)}):{},{aC:C.value},C.value?e.e({aD:e.t(O.value),aE:e.f(Q.value,(t,a,n)=>({a:e.t(t.agentName),b:e.t(t.amount.toLocaleString()),c:e.t(L(t.createdAt)),d:t.id})),aF:0===Q.value.length},(Q.value.length,{}),{aG:e.o(e=>C.value=!1),aH:e.o(B),aI:e.o(e=>C.value=!1)}):{})}}),r=e._export_sfc(l,[["__scopeId","data-v-561626ef"]]);wx.createPage(r);
