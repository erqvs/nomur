"use strict";const e=require("../../../common/vendor.js"),t=require("../../../common/assets.js"),i=require("../../../stores/app.js"),a=require("../../../api/index.js"),o=e.defineComponent({__name:"index",setup(o){const n=i.useAppStore(),d=e.computed(()=>n.promotions),s=e.computed(()=>n.products),u=e.ref(!1),l=e.ref(!1),c=e.ref({name:"",description:"",threshold:100,conditionProducts:[],gifts:[],startDate:"",endDate:""}),r=e.ref([]),v=()=>{l.value=!0},p=()=>{setTimeout(()=>{l.value=!1},300)},h=e.computed(()=>c.value.gifts.map(e=>e.productId)),f=e=>r.value.includes(e)||c.value.conditionProducts.includes(e),m=e=>c.value.conditionProducts.includes(e),g=()=>{r.value=[]},x=()=>{r.value.length<2?e.index.showToast({title:"请至少选择2个产品",icon:"none"}):(r.value.forEach(e=>{const t=c.value.conditionProducts.indexOf(e);t>-1&&c.value.conditionProducts.splice(t,1)}),r.value.forEach(e=>{c.value.conditionProducts.includes(e)||c.value.conditionProducts.push(e)}),e.index.showToast({title:"组合已保存",icon:"success"}),g())},w=e=>h.value.includes(e),y=e=>{if(!e)return"";try{const t=new Date(e),i=t.getFullYear(),a=String(t.getMonth()+1).padStart(2,"0");return`${i}-${a}-${String(t.getDate()).padStart(2,"0")}`}catch(t){return e.match(/^\d{4}-\d{2}-\d{2}/)?e.split("T")[0]:e}},D=e=>c.value.gifts.findIndex(t=>t.productId===e),P=e=>{const t=c.value.gifts.find(t=>t.productId===e);return(null==t?void 0:t.quantity)||1},q=(e,t)=>{if(e>-1&&e<c.value.gifts.length){const i=c.value.gifts[e].quantity+t;c.value.gifts[e].quantity=Math.max(1,i)}},T=async()=>{if(c.value.name)if(0!==c.value.gifts.length){for(const t of c.value.gifts)if(!t.quantity||t.quantity<=0)return void e.index.showToast({title:"请设置所有赠品的数量",icon:"none"});try{const t=c.value.gifts.map(e=>{const t=s.value.find(t=>t.id===e.productId);return{productId:e.productId,productName:(null==t?void 0:t.name)||"",quantity:e.quantity}});await a.promotionApi.create({name:c.value.name,description:c.value.description,threshold:c.value.threshold,conditionProducts:c.value.conditionProducts,gifts:t,isActive:!0,startDate:c.value.startDate,endDate:c.value.endDate}),await n.loadPromotions(),e.index.showToast({title:"添加成功",icon:"success"}),u.value=!1,c.value={name:"",description:"",threshold:100,conditionProducts:[],gifts:[],startDate:"",endDate:""},r.value=[]}catch(t){e.index.showToast({title:"添加失败",icon:"none"})}}else e.index.showToast({title:"请至少选择一个赠品",icon:"none"});else e.index.showToast({title:"请输入活动名称",icon:"none"})};return(i,o)=>e.e({a:e.f(d.value,(t,i,o)=>({a:e.t(t.isActive?"进行中":"已结束"),b:t.isActive?1:"",c:e.t(t.isActive?"停用":"启用"),d:e.o(i=>(async(t,i)=>{i.stopPropagation();try{await a.promotionApi.update(t.id,{isActive:!t.isActive}),await n.loadPromotions(),e.index.showToast({title:t.isActive?"已停用":"已启用",icon:"success"})}catch(o){e.index.showToast({title:o.message||"操作失败",icon:"none"})}})(t,i),t.id),e:e.o(i=>{return o=t.id,i.stopPropagation(),void e.index.showModal({title:"确认删除",content:"确定要删除这个促销活动吗？",success:async t=>{if(t.confirm)try{await a.promotionApi.delete(o),await n.loadPromotions(),e.index.showToast({title:"删除成功",icon:"success"})}catch(i){e.index.showToast({title:i.message||"删除失败",icon:"none"})}}});var o},t.id),f:e.o(()=>{},t.id),g:e.t(t.name),h:e.t(t.description),i:e.t(t.threshold),j:e.f(t.gifts,(t,i,a)=>({a:e.t(t.productName),b:e.t(t.quantity),c:t.productId})),k:e.t(y(t.startDate)),l:e.t(y(t.endDate)),m:t.id,n:e.o(i=>{return a=t.id,void e.index.navigateTo({url:`/pages/admin/promotions/edit?id=${a}`});var a},t.id)})),b:0===d.value.length},0===d.value.length?{c:t._imports_0$6}:{},{d:e.o(e=>u.value=!0),e:u.value},u.value?e.e({f:c.value.name,g:e.o(e=>c.value.name=e.detail.value),h:c.value.description,i:e.o(e=>c.value.description=e.detail.value),j:c.value.threshold,k:e.o(e.m(e=>c.value.threshold=e.detail.value,{number:!0})),l:e.f(s.value,(t,i,a)=>e.e({a:f(t.id)},(f(t.id),{}),{b:e.t(t.name),c:e.o(i=>(t=>{e.index.vibrateShort({type:"light"});const i=r.value.indexOf(t);if(i>-1)r.value.splice(i,1);else{const e=c.value.conditionProducts.indexOf(t);e>-1&&c.value.conditionProducts.splice(e,1),r.value.push(t)}})(t.id),t.id),d:m(t.id)},(m(t.id),{}),{e:t.id,f:f(t.id)?1:"",g:m(t.id)?1:""})),m:r.value.length>1},r.value.length>1?{n:e.t(r.value.map(e=>{var t;return(null==(t=s.value.find(t=>t.id===e))?void 0:t.name)||e}).join(" + ")),o:e.o(g),p:e.o(x),q:e.t(c.value.threshold)}:{},{r:e.f(s.value,(t,i,a)=>e.e({a:w(t.id)},(w(t.id),{}),{b:e.t(t.name),c:e.o(e=>(e=>{const t=c.value.gifts.findIndex(t=>t.productId===e);t>-1?c.value.gifts.splice(t,1):c.value.gifts.push({productId:e,quantity:1})})(t.id),t.id),d:w(t.id)},w(t.id)?{e:e.o(e=>q(D(t.id),-1),t.id),f:P(t.id),g:e.o(e=>{var i,a;return((e,t)=>{const i=D(e);i>-1&&(c.value.gifts[i].quantity=Math.max(1,t||1))})(t.id,Number((null==(i=e.detail)?void 0:i.value)??(null==(a=e.target)?void 0:a.value)??0))},t.id),h:e.o(e=>q(D(t.id),1),t.id),i:e.o(()=>{},t.id)}:{},{j:t.id,k:w(t.id)?1:""})),s:e.t(c.value.startDate||"选择开始日期"),t:e.o(v),v:c.value.startDate,w:e.o(e=>{c.value.startDate=e.detail.value,p()}),x:e.t(c.value.endDate||"选择结束日期"),y:e.o(v),z:c.value.endDate,A:e.o(e=>{c.value.endDate=e.detail.value,p()}),B:e.o(e=>u.value=!1),C:e.o(T),D:e.o(()=>{}),E:e.n({"modal-mask--hidden":l.value}),F:e.o(e=>u.value=!1)}):{})}}),n=e._export_sfc(o,[["__scopeId","data-v-34c36886"]]);wx.createPage(n);
