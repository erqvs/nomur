"use strict";const e=require("../../../common/vendor.js"),t=require("../../../stores/app.js"),n=require("../../../api/index.js"),a=e.defineComponent({__name:"edit",setup(a){const i=t.useAppStore(),o=e.ref(""),d=e.computed(()=>i.products),u=e.ref({name:"",description:"",threshold:100,conditionProducts:[],conditionGroupId:"",gifts:[],startDate:"",endDate:""}),s=e.ref([]),l=e.ref([]),r=e=>e.includes("芒果")?"芒果":e.includes("茶")?"茶":e.includes("龙眼")||e.includes("水果")?"水果":e.split(/[茶果汁]/)[0]||e,c=e.computed(()=>{const e=new Map;return d.value.forEach(t=>{const n=r(t.name);e.has(n)||e.set(n,[]),e.get(n).push({id:t.id,name:t.name})}),Array.from(e.entries()).map(([e,t])=>({name:e,products:t}))}),v=e=>l.value.includes(e)||u.value.conditionProducts.includes(e),p=e=>u.value.conditionProducts.includes(e),m=()=>{l.value=[]},f=()=>{u.value.conditionGroupId="",u.value.conditionProducts=[],l.value=[]},h=()=>{l.value.length<2?e.index.showToast({title:"请至少选择2个产品",icon:"none"}):(l.value.forEach(e=>{const t=u.value.conditionProducts.indexOf(e);t>-1&&u.value.conditionProducts.splice(t,1)}),l.value.forEach(e=>{u.value.conditionProducts.includes(e)||u.value.conditionProducts.push(e)}),e.index.showToast({title:"组合已保存",icon:"success"}),m())},g=e=>u.value.gifts.some(t=>t.type===e),y=e=>u.value.gifts.findIndex(t=>t.type===e),I=e=>{const t=u.value.gifts.find(t=>t.type===e);return(null==t?void 0:t.quantity)||1},x=(e,t)=>{const n=y(e);if(n>-1){const e=u.value.gifts[n].quantity+t;u.value.gifts[n].quantity=Math.max(1,e)}},w=e=>{if(!e)return"";try{if(/^\d{4}-\d{2}-\d{2}$/.test(e))return e;const t=new Date(e);if(isNaN(t.getTime()))return e;const n=t.getFullYear(),a=String(t.getMonth()+1).padStart(2,"0");return`${n}-${a}-${String(t.getDate()).padStart(2,"0")}`}catch(t){return e}};e.onMounted(async()=>{await(async()=>{try{s.value=await n.productGroupApi.getAll()}catch(t){console.error("加载产品组合失败:",t),e.index.showToast({title:"加载产品组合失败",icon:"none"})}})(),0===i.products.length&&await i.loadProducts()}),e.onLoad(async t=>{if(0===i.products.length&&await i.loadProducts(),null==t?void 0:t.id){o.value=t.id,e.index.setNavigationBarTitle({title:"编辑促销活动"});try{const e=(await n.promotionApi.getAll()).find(e=>e.id===t.id);if(e){const t=e.gifts.map(e=>{if(e.type)return{type:e.type,quantity:e.quantity,productIds:e.productIds||[]};const t=d.value.find(t=>t.id===e.productId);if(t){const n=r(t.name),a=c.value.find(e=>e.name===n);return{type:n,quantity:e.quantity,productIds:a?a.products.map(e=>e.id):[e.productId]}}return null}).filter(e=>null!==e);u.value={name:e.name,description:e.description||"",threshold:e.threshold,conditionProducts:e.conditionProducts||[],conditionGroupId:e.conditionGroupId||"",gifts:t,startDate:w(e.startDate),endDate:w(e.endDate)}}}catch(a){e.index.showToast({title:"加载失败",icon:"none"}),setTimeout(()=>{e.index.navigateBack()},1500)}}});const P=async()=>{if(u.value.name)if(0!==u.value.gifts.length){for(const t of u.value.gifts)if(!t.quantity||t.quantity<=0)return void e.index.showToast({title:"请设置所有赠品的数量",icon:"none"});try{const t=u.value.gifts.map(e=>{var t;return{type:e.type,quantity:e.quantity,productIds:e.productIds,productId:e.productIds[0]||"",productName:e.productIds.length>0&&(null==(t=d.value.find(t=>t.id===e.productIds[0]))?void 0:t.name)||e.type}});await n.promotionApi.update(o.value,{name:u.value.name,description:u.value.description,threshold:u.value.threshold,conditionProducts:u.value.conditionProducts,conditionGroupId:u.value.conditionGroupId,gifts:t,startDate:u.value.startDate,endDate:u.value.endDate}),await i.loadPromotions(),e.index.showToast({title:"保存成功",icon:"success"}),setTimeout(()=>{e.index.navigateBack()},1500)}catch(t){e.index.showToast({title:t.message||"保存失败",icon:"none"})}}else e.index.showToast({title:"请至少选择一个赠品",icon:"none"});else e.index.showToast({title:"请输入活动名称",icon:"none"})};return(t,n)=>e.e({a:u.value.name,b:e.o(e=>u.value.name=e.detail.value),c:u.value.description,d:e.o(e=>u.value.description=e.detail.value),e:u.value.threshold,f:e.o(e.m(e=>u.value.threshold=e.detail.value,{number:!0})),g:e.f(s.value,(t,n,a)=>e.e({a:u.value.conditionGroupId===t.id},(u.value.conditionGroupId,t.id,{}),{b:e.t(t.name),c:e.t(t.productIds.map(e=>(e=>{const t=d.value.find(t=>t.id===e);return(null==t?void 0:t.name)||""})(e)).join(" + ")),d:t.id,e:u.value.conditionGroupId===t.id?1:"",f:e.o(n=>(t=>{e.index.vibrateShort({type:"light"}),u.value.conditionGroupId=t.id,u.value.conditionProducts=[...t.productIds],l.value=[]})(t),t.id)})),h:u.value.conditionGroupId},u.value.conditionGroupId?{i:e.o(f)}:{},{j:e.f(d.value,(t,n,a)=>e.e({a:v(t.id)},(v(t.id),{}),{b:e.t(t.name),c:e.o(n=>(t=>{e.index.vibrateShort({type:"light"});const n=l.value.indexOf(t);if(n>-1)l.value.splice(n,1);else{const e=u.value.conditionProducts.indexOf(t);e>-1&&u.value.conditionProducts.splice(e,1),l.value.push(t)}})(t.id),t.id),d:p(t.id)},(p(t.id),{}),{e:t.id,f:v(t.id)?1:"",g:p(t.id)?1:""})),k:l.value.length>1},l.value.length>1?{l:e.t(l.value.map(e=>{var t;return(null==(t=d.value.find(t=>t.id===e))?void 0:t.name)||e}).join(" + ")),m:e.o(m),n:e.o(h),o:e.t(u.value.threshold)}:{},{p:e.f(c.value,(t,n,a)=>e.e({a:g(t.name)},(g(t.name),{}),{b:e.t(t.name),c:e.t(t.products.map(e=>e.name).join("、")),d:e.o(e=>(e=>{const t=u.value.gifts.findIndex(t=>t.type===e);if(t>-1)u.value.gifts.splice(t,1);else{const t=c.value.find(t=>t.name===e);t&&u.value.gifts.push({type:e,quantity:1,productIds:t.products.map(e=>e.id)})}})(t.name),t.name),e:g(t.name)},g(t.name)?{f:e.o(e=>x(t.name,-1),t.name),g:I(t.name),h:e.o(e=>{var n,a;return((e,t)=>{const n=y(e);n>-1&&(u.value.gifts[n].quantity=Math.max(1,t||1))})(t.name,Number((null==(n=e.detail)?void 0:n.value)??(null==(a=e.target)?void 0:a.value)??0))},t.name),i:e.o(e=>x(t.name,1),t.name),j:e.o(()=>{},t.name)}:{},{k:t.name,l:g(t.name)?1:""})),q:e.t(u.value.startDate||"选择开始日期"),r:u.value.startDate,s:e.o(e=>u.value.startDate=e.detail.value),t:e.t(u.value.endDate||"选择结束日期"),v:u.value.endDate,w:e.o(e=>u.value.endDate=e.detail.value),x:e.o(P)})}}),i=e._export_sfc(a,[["__scopeId","data-v-c4ed6620"]]);wx.createPage(i);
