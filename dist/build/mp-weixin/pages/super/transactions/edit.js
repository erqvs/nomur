"use strict";const e=require("../../../common/vendor.js"),a=require("../../../stores/app.js"),t=require("../../../api/index.js");Math||n();const n=()=>"../../../components/QuickInput/index.js",u=e.defineComponent({__name:"edit",setup(n){const u=a.useAppStore(),l=e.ref(""),o=e.ref(!0),v=e.ref(null),r=e.ref(0),i=e.ref([]),d=e.ref(!1),c=e.ref(!1),s=[{label:"充值",value:"recharge"},{label:"扣款",value:"deduct"}],m=e.ref({agentId:"",type:"recharge",reason:"payment",amount:0,remark:"",paymentAccountId:""}),g=e.computed(()=>"recharge"===m.value.type?[{label:"赠送",value:"gift"},{label:"代理打款",value:"payment"},{label:"运费",value:"freight"},{label:"调货收入",value:"transfer_in"},{label:"营销送礼退款",value:"marketing"}]:[{label:"发货扣款",value:"shipping"},{label:"罚款",value:"fine"},{label:"调货支出",value:"transfer_out"}]),p=e.computed(()=>{var e;if(!m.value.agentId)return 0;const a=u.agents.find(e=>e.id===m.value.agentId);if(!a)return 0;if(m.value.agentId===(null==(e=v.value)?void 0:e.agentId)){const e=r.value;return m.value.amount>0?e+m.value.amount:e-Math.abs(m.value.amount)}return m.value.amount>0?a.balance+m.value.amount:a.balance-Math.abs(m.value.amount)}),f=e.computed(()=>{var e;if(!m.value.agentId)return 0;if(m.value.agentId===(null==(e=v.value)?void 0:e.agentId))return m.value.amount-v.value.amount;return u.agents.find(e=>e.id===m.value.agentId)?m.value.amount:0}),h=e.computed(()=>{var e;if(!m.value.agentId)return"请选择代理商";if(m.value.agentId===(null==(e=v.value)?void 0:e.agentId))return f.value>0?`余额将增加 ¥${Math.abs(f.value).toLocaleString()}`:f.value<0?`余额将减少 ¥${Math.abs(f.value).toLocaleString()}`:"余额不变";{const e=u.agents.find(e=>e.id===m.value.agentId),a=u.agents.find(e=>{var a;return e.id===(null==(a=v.value)?void 0:a.agentId)});return e&&a?`原代理商"${a.name}"余额将恢复 ¥${Math.abs(v.value.amount).toLocaleString()}，新代理商"${e.name}"余额将${m.value.amount>0?"增加":"减少"} ¥${Math.abs(m.value.amount).toLocaleString()}`:""}}),I=e=>{const a=u.agents.find(a=>a.id===e);return(null==a?void 0:a.name)||""},b=e=>{const a=i.value.find(a=>a.id===e);return(null==a?void 0:a.name)||""},y=e=>{const a=Math.abs(e).toLocaleString();return e<0?`-¥${a}`:`¥${a}`},A=a=>{m.value.paymentAccountId=a,c.value=!1,e.index.vibrateShort({type:"light"})},x=async()=>{if(m.value.agentId)if(m.value.amount&&0!==m.value.amount)if(u.currentAdmin&&"super_admin"===u.currentAdmin.role)try{e.index.showLoading({title:"保存中..."}),await t.transactionApi.update(l.value,{agentId:m.value.agentId,amount:m.value.amount,reason:m.value.reason,remark:m.value.remark,paymentAccountId:m.value.paymentAccountId||void 0},u.currentAdmin.id,u.currentAdmin.role),e.index.hideLoading(),e.index.showToast({title:"修改成功",icon:"success"}),await Promise.all([u.loadTransactions(),u.loadAgents()]),setTimeout(()=>{e.index.navigateBack()},1500)}catch(a){e.index.hideLoading(),e.index.showToast({title:a.message||"修改失败",icon:"none"})}else e.index.showToast({title:"需要超级管理员权限",icon:"none"});else e.index.showToast({title:"请输入有效的金额",icon:"none"});else e.index.showToast({title:"请选择代理商",icon:"none"})};return e.onLoad(async a=>{if(!(null==a?void 0:a.id))return e.index.showToast({title:"缺少交易记录ID",icon:"none"}),void setTimeout(()=>e.index.navigateBack(),1500);l.value=a.id;try{o.value=!0,await Promise.all([u.loadTransactions(),u.loadAgents()]);try{i.value=await t.paymentAccountApi.getAll()}catch(n){console.error("加载收款账户失败:",n)}if(v.value=u.transactions.find(e=>e.id===l.value)||null,!v.value)return e.index.showToast({title:"交易记录不存在",icon:"none"}),void setTimeout(()=>e.index.navigateBack(),1500);const a=u.agents.find(e=>e.id===v.value.agentId);a&&(v.value.amount>0?r.value=a.balance-v.value.amount:r.value=a.balance+Math.abs(v.value.amount)),m.value={agentId:v.value.agentId,type:v.value.type,reason:v.value.reason,amount:v.value.amount,remark:v.value.remark||"",paymentAccountId:v.value.paymentAccountId||""},o.value=!1}catch(n){o.value=!1,e.index.showToast({title:n.message||"加载失败",icon:"none"}),setTimeout(()=>e.index.navigateBack(),1500)}}),(a,t)=>{return e.e({a:o.value},o.value?{}:v.value?e.e({c:e.t(v.value.agentName),d:e.t((l=v.value.type,"recharge"===l?"充值":"扣款")),e:e.t((n=v.value.reason,{gift:"赠送",payment:"代理打款",freight:"运费",shipping:"发货扣款",fine:"罚款",transfer_in:"调货收入",transfer_out:"调货支出",marketing:"营销送礼退款"}[n]||n)),f:e.t(v.value.amount>0?"+":""),g:e.t(Math.abs(v.value.amount).toLocaleString()),h:v.value.amount>0?1:"",i:v.value.amount<0?1:"",j:e.t(y(r.value)),k:e.t(m.value.agentId?I(m.value.agentId):"请选择代理商"),l:e.n({placeholder:!m.value.agentId}),m:e.o(e=>d.value=!0),n:e.f(s,(a,t,n)=>({a:e.t(a.label),b:a.value,c:m.value.type===a.value?1:"",d:e.o(e=>m.value.type=a.value,a.value)})),o:e.f(g.value,(a,t,n)=>({a:e.t(a.label),b:a.value,c:m.value.reason===a.value?1:"",d:e.o(e=>m.value.reason=a.value,a.value)})),p:e.o(e.m(e=>m.value.amount=e,{number:!0},!0)),q:e.p({type:"number",placeholder:"请输入金额（正数为充值，负数为扣款）",modelValue:m.value.amount}),r:"recharge"===m.value.type&&"payment"===m.value.reason},"recharge"===m.value.type&&"payment"===m.value.reason?{s:e.t(m.value.paymentAccountId?b(m.value.paymentAccountId):"请选择收款账户（可选）"),t:e.n({placeholder:!m.value.paymentAccountId}),v:e.o(e=>c.value=!0)}:{},{w:m.value.remark,x:e.o(e=>m.value.remark=e.detail.value),y:e.t(y(r.value)),z:e.t(v.value.amount>0?"+":""),A:e.t(Math.abs(v.value.amount).toLocaleString()),B:v.value.amount>0?1:"",C:v.value.amount<0?1:"",D:e.t(y(p.value)),E:e.t(m.value.amount>0?"+":""),F:e.t(Math.abs(m.value.amount).toLocaleString()),G:m.value.amount>0?1:"",H:m.value.amount<0?1:"",I:e.t(f.value>0?"+":""),J:e.t(Math.abs(f.value).toLocaleString()),K:f.value>0?1:"",L:f.value<0?1:"",M:e.t(h.value),N:e.o(x)}):{},{b:v.value,O:d.value},d.value?{P:e.o(e=>d.value=!1),Q:e.f(e.unref(u).agents,(a,t,n)=>({a:e.t(a.name),b:e.t(y(a.balance)),c:a.id,d:m.value.agentId===a.id?1:"",e:e.o(t=>{return n=a.id,m.value.agentId=n,d.value=!1,void e.index.vibrateShort({type:"light"});var n},a.id)})),R:e.o(()=>{}),S:e.o(e=>d.value=!1)}:{},{T:c.value},c.value?{U:e.o(e=>c.value=!1),V:m.value.paymentAccountId?"":1,W:e.o(e=>A("")),X:e.f(i.value,(a,t,n)=>e.e({a:e.t(a.name),b:a.accountNo},a.accountNo?{c:e.t(a.accountNo)}:{},{d:a.id,e:m.value.paymentAccountId===a.id?1:"",f:e.o(e=>A(a.id),a.id)})),Y:e.o(()=>{}),Z:e.o(e=>c.value=!1)}:{});var n,l}}}),l=e._export_sfc(u,[["__scopeId","data-v-ac183a3f"]]);wx.createPage(l);
