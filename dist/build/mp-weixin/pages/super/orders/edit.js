"use strict";const e=require("../../../common/vendor.js"),t=require("../../../common/assets.js"),a=require("../../../stores/app.js"),i=require("../../../api/index.js");Math||(o+n+l)();const o=()=>"../../../components/TagSelect/index.js",n=()=>"../../../components/QuickInput/index.js",l=()=>"../../../components/ImageUploader/index.js",d=e.defineComponent({__name:"edit",setup(o){const n=a.useAppStore(),l=e.ref(""),d=e.ref(!0),r=e.ref(null),u=e.ref({agentId:null,items:[],totalWeight:0,totalAmount:0,driverPhone:"",promotionIds:[],images:[],remark:""}),s=e.computed(()=>n.agents.map(e=>({label:e.name,value:e.id,subLabel:`¥${e.balance.toLocaleString()}`}))),m=e.computed(()=>n.promotions.filter(e=>e.isActive).map(e=>({label:e.name,value:e.id,subLabel:e.description}))),v=e.computed(()=>{var e;return(null==(e=r.value)?void 0:e.giftItems)?r.value.giftItems:[]}),p=e.computed(()=>n.products),c=e=>u.value.items.some(t=>t.productId===e),g=e=>{const t=u.value.items.find(t=>t.productId===e);return(null==t?void 0:t.quantity)||0},h=(e,t)=>{const a=u.value.items.find(t=>t.productId===e);if(a){const i=t>0?10:1;a.quantity=Math.max(1,a.quantity+t*i);const o=p.value.find(t=>t.id===e);o&&(a.price=o.price,a.weight=o.weight)}},I=e=>{const t=new Date(e);return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")} ${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`},f=async()=>{var t;if(u.value.agentId)if(0!==u.value.items.length)if(!u.value.totalWeight||u.value.totalWeight<=0)e.index.showToast({title:"请输入有效的总重量",icon:"none"});else if(!u.value.totalAmount||u.value.totalAmount<=0)e.index.showToast({title:"请输入有效的总金额",icon:"none"});else if(n.currentAdmin&&"super_admin"===n.currentAdmin.role)try{e.index.showLoading({title:"保存中..."});const a=u.value.promotionIds.length>0?1===u.value.promotionIds.length?u.value.promotionIds[0]:JSON.stringify(u.value.promotionIds):void 0,o=(null==(t=r.value)?void 0:t.giftItems)||[];await i.orderApi.update(l.value,{agentId:u.value.agentId,items:u.value.items,totalWeight:u.value.totalWeight,totalAmount:u.value.totalAmount,driverPhone:u.value.driverPhone||void 0,promotionId:a,giftItems:o.length>0?o:void 0,images:u.value.images,remark:u.value.remark||void 0},n.currentAdmin.id,n.currentAdmin.role),e.index.hideLoading(),e.index.showToast({title:"修改成功",icon:"success"}),await n.loadOrders(),await n.loadAgents(),setTimeout(()=>{e.index.navigateBack()},1500)}catch(a){e.index.hideLoading(),e.index.showToast({title:a.message||"修改失败",icon:"none"})}else e.index.showToast({title:"需要超级管理员权限",icon:"none"});else e.index.showToast({title:"请至少选择一个商品",icon:"none"});else e.index.showToast({title:"请选择代理商",icon:"none"})};return e.onLoad(async t=>{(null==t?void 0:t.id)?(l.value=t.id,e.index.setNavigationBarTitle({title:"修改订单"}),0===n.products.length&&await n.loadProducts(),0===n.agents.length&&await n.loadAgents(),0===n.promotions.length&&await n.loadPromotions(),await(async()=>{try{d.value=!0;const e=await i.orderApi.getById(l.value);r.value=e,u.value={agentId:e.agentId,items:e.items.map(e=>({...e})),totalWeight:e.totalWeight,totalAmount:e.totalAmount,driverPhone:e.driverPhone||"",promotionIds:Array.isArray(e.promotionId)?e.promotionId:e.promotionId?[e.promotionId]:[],images:e.images||[],remark:e.remark||""}}catch(t){e.index.showToast({title:"加载订单失败",icon:"none"}),setTimeout(()=>{e.index.navigateBack()},1500)}finally{d.value=!1}})()):(e.index.showToast({title:"订单ID不存在",icon:"none"}),setTimeout(()=>{e.index.navigateBack()},1500))}),(a,i)=>e.e({a:d.value},d.value?{}:r.value?e.e({c:e.t(r.value.id.slice(-8).toUpperCase()),d:e.o(e=>u.value.agentId=e),e:e.p({options:s.value,label:"",modelValue:u.value.agentId}),f:e.t(I(r.value.createdAt)),g:e.f(e.unref(n).products,(t,a,i)=>e.e({a:c(t.id)},(c(t.id),{}),{b:e.t(t.name),c:e.o(a=>(t=>{if(e.index.vibrateShort({type:"light"}),c(t))u.value.items=u.value.items.filter(e=>e.productId!==t);else{const e=p.value.find(e=>e.id===t);e&&u.value.items.push({productId:e.id,productName:e.name,quantity:10,price:e.price,weight:e.weight})}})(t.id),t.id),d:c(t.id)},c(t.id)?{e:e.o(e=>h(t.id,-1),t.id),f:g(t.id),g:e.o(e=>{var a,i;return((e,t)=>{const a=u.value.items.find(t=>t.productId===e);if(a){a.quantity=Math.max(1,t||1);const i=p.value.find(t=>t.id===e);i&&(a.price=i.price,a.weight=i.weight)}})(t.id,Number((null==(a=e.detail)?void 0:a.value)??(null==(i=e.target)?void 0:i.value)??0))},t.id),h:e.o(e=>h(t.id,1),t.id),i:e.o(()=>{},t.id)}:{},{j:t.id,k:c(t.id)?1:""})),h:e.o(e=>u.value.totalWeight=e),i:e.p({type:"digit",placeholder:"请输入总重量",modelValue:u.value.totalWeight}),j:e.o(e=>u.value.totalAmount=e),k:e.p({type:"digit",prefix:"¥",placeholder:"请输入总金额",modelValue:u.value.totalAmount}),l:e.o(e=>u.value.driverPhone=e),m:e.p({type:"number",placeholder:"请输入司机手机号",modelValue:u.value.driverPhone}),n:e.o(e=>u.value.promotionIds=e),o:e.p({options:m.value,multiple:!0,label:"",modelValue:u.value.promotionIds}),p:v.value.length>0},v.value.length>0?{q:e.f(v.value,(t,a,i)=>({a:e.t(t.productName),b:e.t(t.quantity),c:t.productId})),r:t._imports_0$6}:{},{s:e.o(e=>u.value.images=e),t:e.p({label:"",tip:"可上传订单相关图片",modelValue:u.value.images}),v:u.value.remark,w:e.o(e=>u.value.remark=e.detail.value),x:e.o(f)}):{},{b:r.value})}}),r=e._export_sfc(d,[["__scopeId","data-v-a4426ceb"]]);wx.createPage(r);
