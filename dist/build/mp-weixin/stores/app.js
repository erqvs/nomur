"use strict";const t=require("../common/vendor.js"),e=require("../api/index.js"),a=t.defineStore("app",()=>{const a=t.ref("admin"),r=t.ref("a1"),o=t.ref(null),n=t.ref(""),s=t.computed(()=>{var t;return"super_admin"===(null==(t=o.value)?void 0:t.role)}),i=t.ref([]),c=t.ref([]),l=t.ref([]),d=t.ref([]),u=t.ref([]),p=t.ref([]),g=t.ref({totalShipments:0,last30DaysShipments:0,productStats:[],last30DaysProductStats:[]}),m=t.ref(!1),A=t.computed(()=>c.value.find(t=>t.id===r.value)),y=t.computed(()=>g.value),f=async()=>{try{i.value=await e.productApi.getAll()}catch(t){console.error("加载商品失败:",t)}},v=async()=>{try{c.value=await e.agentApi.getAll()}catch(t){console.error("加载代理商失败:",t)}},w=async()=>{try{p.value=await e.driverApi.getAll()}catch(t){console.error("加载司机失败:",t)}},h=async()=>{try{u.value=await e.promotionApi.getAll()}catch(t){console.error("加载促销活动失败:",t)}},I=async t=>{try{l.value=await e.orderApi.getAll(t)}catch(a){console.error("加载订单失败:",a)}},P=async t=>{try{d.value=await e.transactionApi.getAll(t)}catch(a){console.error("加载交易流水失败:",a)}},S=async()=>{try{g.value=await e.statisticsApi.get()}catch(t){console.error("加载统计数据失败:",t)}};return{userRole:a,currentAgentId:r,currentAdmin:o,products:i,agents:c,orders:l,transactions:d,promotions:u,drivers:p,loading:m,currentAgent:A,globalStats:y,isSuperAdmin:s,initData:async()=>{m.value=!0;try{await Promise.all([f(),v(),w(),h(),I(),P(),S()])}finally{m.value=!1}},loadProducts:f,loadAgents:v,loadDrivers:w,loadPromotions:h,loadOrders:I,loadTransactions:P,loadStatistics:S,getAgentStats:t=>{const e=c.value.find(e=>e.id===t);if(!e)return null;const a=l.value.filter(e=>e.agentId===t),r={};a.forEach(t=>{t.items.forEach(t=>{const e=t.productId;e&&(r[e]=(r[e]||0)+t.quantity)})});const o={};return Object.keys(e.yearlyTargets).forEach(t=>{const a=e.yearlyTargets[t]||0,n=r[t]||0;o[t]={target:a,completed:n,percentage:a>0?Math.round(n/a*100):0}}),{agentId:t,yearlyStats:o,promotionProgress:{purchased:Object.values(r).reduce((t,e)=>t+e,0),giftsEarned:[]}}},getAgentOrders:t=>l.value.filter(e=>e.agentId===t),getAgentTransactions:t=>d.value.filter(e=>e.agentId===t),addProduct:async t=>{const a=await e.productApi.create(t);return await f(),a},updateProduct:async(t,a)=>{await e.productApi.update(t,a),await f()},deleteProduct:async t=>{await e.productApi.delete(t),await f()},addAgent:async t=>{const a=await e.agentApi.create(t);return await v(),a},createOrder:async t=>{const a=await e.orderApi.create({agentId:t.agentId,items:t.items,totalWeight:t.totalWeight,totalAmount:t.totalAmount,driverPhone:t.driverPhone,promotionId:t.promotionId,giftItems:t.giftItems,images:t.images});return await Promise.all([I(),v(),P(),S()]),a},recharge:async(t,a,r,o,n,s)=>{const i=await e.transactionApi.recharge({agentId:t,amount:a,reason:r,proof:o,remark:n,paymentAccountId:s});return await Promise.all([v(),P()]),i},deduct:async(t,a,r,o,n)=>{const s=await e.transactionApi.deduct({agentId:t,amount:a,reason:r,remark:o,orderItems:n});return await Promise.all([v(),P()]),s},transfer:async(t,a,r,o,n)=>{const s=await e.transactionApi.transfer({fromAgentId:t,toAgentId:a,amount:r,orderItems:o,remark:n});return await Promise.all([v(),P()]),s},switchRole:t=>{a.value=t},setCurrentAdmin:t=>{o.value=t},tabBarCurrentPath:n,setTabBarPath:t=>{const e=t.startsWith("/")?t:"/"+t;n.value!==e&&(n.value=e)}}});exports.useAppStore=a;
