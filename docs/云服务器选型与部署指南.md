# 云服务器选型与部署指南

## 项目资源需求分析

### 当前技术栈
- **后端**：Node.js + Express（运行在3001端口）
- **数据库**：MySQL（远程数据库，连接池限制10个）
- **前端**：uni-app（支持小程序和H5）
- **文件存储**：本地存储（图片上传，最大10MB/张）
- **并发需求**：20-50人同时使用

### 资源消耗评估
- **CPU**：Node.js单线程，主要处理API请求，轻量级
- **内存**：Node.js进程约50-100MB，加上系统占用，建议2GB+
- **磁盘**：图片存储（预估每月100-500MB），系统+日志，建议20GB+
- **带宽**：小程序图片加载，建议3-5Mbps
- **数据库连接**：连接池10个，足够20-50人使用

---

## 云服务器配置推荐

### 🎯 推荐方案一：腾讯云轻量应用服务器（性价比最高）

#### 配置选择
| 项目 | 配置 | 说明 |
|------|------|------|
| **CPU** | 2核 | 足够处理20-50人并发 |
| **内存** | 4GB | 充足，可运行多个服务 |
| **系统盘** | 60GB SSD | 足够存储图片和系统文件 |
| **带宽** | 5Mbps | 满足小程序图片加载需求 |
| **流量包** | 1000GB/月 | 超出后限速，一般够用 |
| **价格** | **约 ¥288/年** | 新用户首年优惠 |

#### 优势
- ✅ 性价比高，适合中小规模使用
- ✅ 包含流量包，不用担心流量费用
- ✅ 轻量级，开箱即用
- ✅ 支持一键部署应用

#### 购买链接
- 腾讯云轻量应用服务器：https://cloud.tencent.com/product/lighthouse

---

### 🚀 推荐方案二：阿里云ECS（稳定可靠）

#### 配置选择
| 项目 | 配置 | 说明 |
|------|------|------|
| **实例规格** | ecs.t6-c2m1.large | 2核4GB通用型 |
| **系统盘** | 40GB ESSD | 高效云盘 |
| **带宽** | 3Mbps | 按固定带宽计费 |
| **价格** | **约 ¥500-800/年** | 根据活动价格不同 |

#### 优势
- ✅ 稳定性好，适合生产环境
- ✅ 性能稳定，不会因流量波动降速
- ✅ 支持弹性扩容

#### 购买链接
- 阿里云ECS：https://www.aliyun.com/product/ecs

---

### 💰 推荐方案三：华为云ECS（性价比适中）

#### 配置选择
| 项目 | 配置 | 说明 |
|------|------|------|
| **实例规格** | s6.large.2 | 2核4GB |
| **系统盘** | 40GB SSD | 高IO |
| **带宽** | 3Mbps | 按固定带宽 |
| **价格** | **约 ¥400-600/年** | 新用户有优惠 |

---

## 小程序部署特殊要求

### 1. HTTPS 证书（必需）
小程序要求所有请求必须使用 HTTPS。

#### 方案A：使用 acme.sh 自动申请（推荐）
```bash
# 安装 acme.sh
curl https://get.acme.sh | sh

# 使用阿里云DNS验证申请证书（推荐，无需开放80端口）
export Ali_Key="your_ali_key"
export Ali_Secret="your_ali_secret"
~/.acme.sh/acme.sh --issue -d nomur.linkmate.site --dns dns_ali

# 安装证书到 Nginx
~/.acme.sh/acme.sh --install-cert -d nomur.linkmate.site \
  --key-file /etc/nginx/ssl/nomur.linkmate.site.key \
  --fullchain-file /etc/nginx/ssl/nomur.linkmate.site.pem \
  --reloadcmd "systemctl reload nginx"
```

#### 方案B：使用云服务商免费证书
- **腾讯云**：SSL证书（免费版DV证书）
- **阿里云**：数字证书管理服务（免费证书）
- **华为云**：云证书管理服务（免费证书）

### 2. 域名配置
- 需要已备案的域名（国内服务器）
- 配置域名解析到服务器IP
- 配置Nginx反向代理

### 3. Nginx 配置示例
```nginx
server {
    listen 443 ssl http2;
    server_name nomur.linkmate.site;
    
    ssl_certificate /etc/nginx/ssl/nomur.linkmate.site.pem;
    ssl_certificate_key /etc/nginx/ssl/nomur.linkmate.site.key;
    
    # API反向代理
    location /api/ {
        proxy_pass http://127.0.0.1:3001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # 静态文件（上传的图片）
    location /api/uploads/ {
        alias /var/www/nomur/server/uploads/;
        expires 30d;
    }
    
    # H5前端（可选）
    location / {
        root /var/www/nomur/dist/build/h5;
        try_files $uri $uri/ /index.html;
    }
}
```

---

## 部署步骤

### 1. 购买服务器后初始化

```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装 Node.js 20.x
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt install -y nodejs

# 安装 PM2
sudo npm install -g pm2

# 安装 Nginx
sudo apt install -y nginx

# 安装 MySQL 客户端（如果需要本地数据库）
sudo apt install -y mysql-client
```

### 2. 部署后端服务

```bash
# 克隆或上传代码到服务器
cd /var/www
git clone <your-repo> nomur
# 或使用 scp 上传代码

# 进入后端目录
cd nomur/server

# 安装依赖
npm install

# 配置环境变量（如果需要）
# 编辑 server/index.js，修改数据库连接信息

# 使用 PM2 启动服务
pm2 start index.js --name nomur-api
pm2 save
pm2 startup  # 设置开机自启
```

### 3. 配置 Nginx

```bash
# 创建 SSL 证书目录
sudo mkdir -p /etc/nginx/ssl

# 申请并安装 SSL 证书（参考上面的 acme.sh 命令）

# 创建 Nginx 配置
sudo nano /etc/nginx/sites-available/nomur

# 将上面的 Nginx 配置粘贴进去，保存

# 启用配置
sudo ln -s /etc/nginx/sites-available/nomur /etc/nginx/sites-enabled/
sudo nginx -t  # 测试配置
sudo systemctl reload nginx
```

### 4. 配置防火墙

```bash
# 开放 80 和 443 端口
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw enable
```

### 5. 小程序配置

在小程序管理后台配置：
- **服务器域名**：`https://nomur.linkmate.site`
- **request合法域名**：`https://nomur.linkmate.site`
- **uploadFile合法域名**：`https://nomur.linkmate.site`
- **downloadFile合法域名**：`https://nomur.linkmate.site`

---

## 成本估算

### 方案一：腾讯云轻量应用服务器
- **服务器**：¥288/年（新用户首年）
- **域名**：¥55/年（.com域名）
- **SSL证书**：免费（acme.sh）
- **总计**：**约 ¥343/年**

### 方案二：阿里云ECS
- **服务器**：¥500-800/年
- **域名**：¥55/年
- **SSL证书**：免费
- **总计**：**约 ¥555-855/年**

---

## 性能优化建议

### 1. 图片存储优化
如果图片较多，建议使用对象存储（OSS）：
- **腾讯云COS**：¥0.15/GB/月
- **阿里云OSS**：¥0.12/GB/月
- **华为云OBS**：¥0.099/GB/月

### 2. CDN加速（可选）
如果用户分布较广，可配置CDN：
- **腾讯云CDN**：按流量计费，约¥0.15/GB
- **阿里云CDN**：按流量计费，约¥0.24/GB

### 3. 数据库优化
- 当前使用远程数据库，如果延迟较高，可考虑：
  - 在同一云服务商购买数据库实例（RDS）
  - 或使用云数据库MySQL（约¥200-500/年）

---

## 监控与维护

### 1. 服务监控
```bash
# PM2 监控
pm2 monit

# 查看日志
pm2 logs nomur-api

# 查看状态
pm2 status
```

### 2. 自动备份
建议配置数据库和文件自动备份：
```bash
# 创建备份脚本
sudo nano /usr/local/bin/backup-nomur.sh

# 内容：
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
# 备份数据库
mysqldump -h 8.154.33.100 -u root -p'密码' nomur > /backup/db_$DATE.sql
# 备份上传文件
tar -czf /backup/uploads_$DATE.tar.gz /var/www/nomur/server/uploads/

# 设置定时任务（每天凌晨2点）
sudo crontab -e
# 添加：0 2 * * * /usr/local/bin/backup-nomur.sh
```

### 3. 日志管理
```bash
# 配置日志轮转
sudo nano /etc/logrotate.d/nomur

# 内容：
/var/www/nomur/server/uploads/*.log {
    daily
    rotate 7
    compress
    missingok
    notifempty
}
```

---

## 推荐配置总结

### 最佳性价比方案（推荐）
- **服务器**：腾讯云轻量应用服务器 2核4GB 5Mbps
- **价格**：¥288/年（新用户）
- **适用场景**：20-50人使用，完全够用

### 生产环境方案
- **服务器**：阿里云ECS 2核4GB 3Mbps
- **价格**：¥500-800/年
- **适用场景**：对稳定性要求高，需要长期运行

---

## 注意事项

1. **域名备案**：使用国内服务器必须备案域名
2. **SSL证书**：小程序强制要求HTTPS
3. **数据库**：当前使用远程数据库，注意网络延迟
4. **备份**：定期备份数据库和上传的文件
5. **监控**：建议配置服务监控，及时发现问题

---

## 快速部署检查清单

- [ ] 购买云服务器（2核4GB以上）
- [ ] 配置域名解析
- [ ] 安装 Node.js 和 PM2
- [ ] 部署后端代码
- [ ] 申请并配置 SSL 证书
- [ ] 配置 Nginx 反向代理
- [ ] 开放防火墙端口（80, 443）
- [ ] 测试 API 接口
- [ ] 在小程序后台配置服务器域名
- [ ] 配置自动备份
- [ ] 设置服务监控

---

## 技术支持

如有部署问题，可参考：
- 项目文档：`docs/项目操作实战指南.md`
- 服务器信息：`.cursor/rules/rules.mdc`

