# 微信小程序部署指南（Nomur）

本文档用于把本项目（uni-app + Vue3 + TypeScript）构建并发布到 **微信小程序**。

> 📌 **快速开始**  
> 项目构建命令：`npm run build:mp-weixin`  
> 构建输出目录：`/var/www/nomur/dist/build/mp-weixin`

---

## 📋 目录

1. [部署前准备](#部署前准备)
2. [配置 AppID](#1-配置-appid必须)
3. [配置服务器域名](#2-配置微信公众平台服务器域名必须)
4. [确认 API 地址配置](#3-本项目小程序端-api-地址说明重要)
5. [服务器侧确认](#4-服务器侧确认后端已上线时通常不用改)
6. [构建小程序产物](#5-构建微信小程序产物必须)
7. [下载构建产物到本地](#6-下载构建产物到本地)
8. [导入微信开发者工具](#7-用微信开发者工具导入并预览必须)
9. [上传代码](#8-上传代码到微信后台)
10. [提交审核与发布](#9-提交审核与发布上线流程)
11. [更新代码流程](#10-更新代码后的完整流程)
12. [常见问题排查](#常见问题排查)

---

## 部署前准备

在开始部署之前，请确保以下准备工作已完成：

### ✅ 必需条件

1. **微信小程序账号**
   - 已注册微信小程序账号
   - 已完成主体认证（未认证会限制"服务器域名"配置）
   - 获取小程序 AppID

2. **AppID 获取方式**
   - 登录 [微信公众平台](https://mp.weixin.qq.com/)
   - 进入：**开发** → **开发管理** → **开发设置**
   - 在"开发者ID"中可以看到 **AppID（小程序ID）**

3. **后端 API 可公网 HTTPS 访问**
   - 线上域名：`https://100nomur.net`
   - Nginx 已配置 `/api/*` 反向代理到 `http://127.0.0.1:3001`
   - SSL 证书已配置并生效

4. **本地开发环境**
   - 已安装 [微信开发者工具](https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html)
   - 已配置好服务器 SSH 访问（用于下载构建产物）

---

## 1. 配置 AppID（必须）

本项目的小程序 AppID 配置在 `src/manifest.json`：

- **文件路径**：`src/manifest.json`
- **配置字段**：`mp-weixin.appid`

### 操作步骤

1. 打开文件 `/var/www/nomur/src/manifest.json`
2. 找到 `mp-weixin` 配置项
3. 将 `appid` 字段从空字符串 `""` 改为你的真实 AppID

**示例：**

```json
{
  "mp-weixin": {
    "appid": "wx1234567890abcdef"
  }
}
```

> ⚠️ **重要提示**：
> - 不要填测试号 AppID（除非你就是用测试号发布/预览）
> - AppID 必须与微信公众平台中的 AppID 完全一致
> - 配置后需要重新构建才能生效

---

## 2. 配置微信公众平台「服务器域名」（必须，否则真机/线上无法请求接口）

### 为什么需要配置？

微信小程序出于安全考虑，要求所有网络请求必须访问已配置的合法域名。未配置的域名在真机和线上环境会被拦截。

### 操作步骤

1. **登录微信公众平台**
   - 访问：https://mp.weixin.qq.com/
   - 使用小程序管理员账号登录

2. **进入服务器域名配置页面**
   - 导航路径：**开发** → **开发管理** → **开发设置** → **服务器域名**

3. **配置域名**
   在以下域名配置项中都添加你的线上域名：

   | 配置项 | 域名 | 说明 |
   |--------|------|------|
   | **request 合法域名** | `https://100nomur.net` | ✅ 必须配置（所有 API 请求） |
   | **uploadFile 合法域名** | `https://100nomur.net` | ✅ 必须配置（图片上传功能） |
   | **downloadFile 合法域名** | `https://100nomur.net` | ✅ 建议配置（图片展示/下载） |

4. **配置要求**
   - ✅ 必须是 **HTTPS**（不能使用 HTTP）
   - ✅ 不能带路径（只填域名，不填 `/api`）
   - ✅ 不能带端口号（默认 443）
   - ✅ 域名必须已备案（国内服务器）

5. **保存并等待生效**
   - 点击"保存"按钮
   - 修改后通常需要 **5-10 分钟** 才能生效
   - 可以在开发者工具中测试是否生效

> 💡 **提示**：如果暂时无法配置（如域名未备案），可以在开发者工具中勾选"不校验合法域名"进行本地调试，但真机和线上必须配置。

---

## 3. 本项目小程序端 API 地址说明（重要）

H5 版本可以用相对路径 `'/api'` 走同域反代；但微信小程序端通常要求 `uni.request` 使用完整 URL。

本项目已在 `src/api/index.ts` 内做了平台区分：

- **H5**：`/api`
- **小程序（mp-weixin）**：`https://100nomur.net/api`

如果你将来换域名，只需要把小程序端的域名改成新的即可。

---

## 4. 服务器侧确认（后端已上线时通常不用改）

确认后端服务正常：

- PM2 进程：`pm2 list` / `pm2 logs nomur-api`
- Nginx 反代：`/api/*` → `http://127.0.0.1:3001`

简单自检（服务器上执行）：

```bash
curl -I https://100nomur.net/api
```

如果返回 404/405 也不一定是问题（取决于你的 API 根路由是否实现），关键是 **能连通且 HTTPS 正常**。

---

## 5. 构建微信小程序产物（必须）

### 操作步骤

1. **登录服务器**
   ```bash
   ssh your_user@your_server_ip
   ```

2. **进入项目目录**
   ```bash
   cd /var/www/nomur
   ```

3. **安装依赖（如果未安装或依赖有更新）**
   ```bash
   npm install
   ```

4. **执行构建命令**
   ```bash
   npm run build:mp-weixin
   ```

5. **等待构建完成**
   - 构建过程可能需要 1-3 分钟
   - 看到 "Build complete" 或类似提示表示构建成功

### 构建输出

构建成功后，会生成以下目录：

```
/var/www/nomur/dist/build/mp-weixin/
├── app.js
├── app.json
├── app.wxss
├── pages/
├── components/
├── static/
├── project.config.json
└── ... (其他小程序必需文件)
```

### 验证构建结果

可以检查构建目录是否存在：

```bash
ls -la /var/www/nomur/dist/build/mp-weixin
```

如果目录存在且包含 `app.js`、`app.json` 等文件，说明构建成功。

---

## 6. 下载构建产物到本地

由于微信开发者工具需要在本地运行，你需要将服务器上的构建产物下载到本地电脑。

### 方法一：使用 SCP 命令（推荐）

在**本地电脑**的终端执行：

```bash
# 下载整个构建目录
scp -r your_user@your_server_ip:/var/www/nomur/dist/build/mp-weixin ~/Downloads/nomur-miniprogram

# 或者下载到当前目录
scp -r your_user@your_server_ip:/var/www/nomur/dist/build/mp-weixin ./
```

### 方法二：使用 SFTP 工具

使用图形化工具（如 FileZilla、WinSCP、Cyberduck）：
1. 连接到服务器
2. 导航到 `/var/www/nomur/dist/build/mp-weixin`
3. 下载整个 `mp-weixin` 目录到本地

### 方法三：使用 Git（如果项目在 Git 仓库中）

如果构建产物已提交到 Git，可以直接拉取：

```bash
git pull
cd dist/build/mp-weixin
```

> 💡 **建议**：将构建产物下载到一个固定的本地目录，方便后续更新。

---

## 7. 用微信开发者工具导入并预览（必须）

### 操作步骤

1. **打开微信开发者工具**
   - 启动已安装的微信开发者工具
   - 如果没有安装，请先下载：https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html

2. **导入项目**
   - 点击"+" 或"导入项目"按钮
   - 选择"导入项目"

3. **填写项目信息**
   - **项目目录**：选择你刚才下载的 `mp-weixin` 目录（本地路径）
   - **AppID**：选择你的小程序 AppID（必须与 `manifest.json` 中配置的一致）
   - **项目名称**：可以自定义，如 "Nomur微商管理"

4. **确认导入**
   - 点击"导入"按钮
   - 如果是首次导入，工具会自动生成 `project.config.json` 配置文件

### 调试配置

1. **本地调试设置**
   - 在开发者工具中，点击右上角的"详情"按钮
   - 在"本地设置"标签页中：
     - ✅ 勾选 **"不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书"**（仅用于本地调试）
     - ⚠️ 注意：此选项仅在开发者工具中生效，真机和线上环境不会生效

2. **预览功能**
   - 点击工具栏的"预览"按钮
   - 使用微信扫码可以在手机上预览小程序
   - ⚠️ 真机预览时，必须已配置服务器域名，否则接口会失败

### 验证功能

在开发者工具中测试以下功能：
- ✅ 页面能否正常打开
- ✅ API 请求是否正常（查看控制台 Network）
- ✅ 图片上传功能是否正常
- ✅ 数据展示是否正常

> ⚠️ **重要提示**：
> - 开发阶段可以在开发者工具中勾选"不校验合法域名"进行调试
> - 真机预览、体验版、正式版必须配置"服务器域名"，否则接口会失败
> - 如果接口请求失败，检查服务器域名配置是否正确

---

## 8. 上传代码到微信后台

### 操作步骤

1. **在微信开发者工具中上传**
   - 点击工具栏右上角的"上传"按钮
   - 填写版本信息：
     - **版本号**：如 `1.0.0`（建议遵循语义化版本规范）
     - **项目备注**：描述本次更新的内容，如"首次发布"、"修复XX问题"等
   - 点击"上传"按钮

2. **上传成功提示**
   - 上传成功后，会显示"上传成功"提示
   - 代码已上传到微信服务器，但还未发布

### 版本号规范建议

建议使用语义化版本号（Semantic Versioning）：
- **主版本号**：不兼容的 API 修改
- **次版本号**：向下兼容的功能性新增
- **修订号**：向下兼容的问题修正

示例：`1.0.0` → `1.0.1` → `1.1.0` → `2.0.0`

---

## 9. 提交审核与发布（上线流程）

### 第一步：提交审核

1. **登录微信公众平台**
   - 访问：https://mp.weixin.qq.com/
   - 进入小程序管理后台

2. **进入版本管理**
   - 导航路径：**管理** → **版本管理**
   - 在"开发版本"中可以看到刚才上传的版本

3. **提交审核**
   - 点击"提交审核"按钮
   - 填写审核信息：
     - **版本描述**：说明本次更新的功能或修复
     - **测试账号**（如需要）：提供测试账号和密码
     - **类目**：选择小程序所属类目（必须选择）
     - **隐私设置**：配置用户隐私保护指引（如涉及用户信息收集）

4. **等待审核**
   - 审核时间通常为 1-7 个工作日
   - 可以在"版本管理"中查看审核状态
   - 审核结果会通过站内信通知

### 第二步：发布上线

1. **审核通过后发布**
   - 审核通过后，在"版本管理"的"审核版本"中会显示"审核通过"
   - 点击"发布"按钮
   - 确认发布后，小程序正式上线

2. **发布后生效**
   - 发布后，用户可以通过搜索小程序名称或扫码使用
   - 通常需要几分钟到半小时才能完全生效

### 版本类型说明

| 版本类型 | 说明 | 可见范围 |
|---------|------|---------|
| **开发版本** | 开发者上传的代码版本 | 仅开发者可见 |
| **体验版本** | 可设置体验版，供指定用户测试 | 体验者可见 |
| **审核版本** | 已提交审核的版本 | 审核中，不可用 |
| **线上版本** | 已发布上线的版本 | 所有用户可见 |

### 体验版设置（可选）

在正式发布前，可以设置体验版供内部测试：

1. 在"版本管理"中，选择开发版本
2. 点击"选为体验版"
3. 在"成员管理"中添加体验者
4. 体验者可以通过小程序后台获取体验版二维码

---

## 10. 更新代码后的完整流程

当修改了代码需要更新小程序时，按以下步骤操作：

### 完整更新流程

1. **修改代码**
   - 在服务器上修改 `src/` 目录下的源代码
   - 或本地修改后推送到服务器

2. **重新构建**
   ```bash
   cd /var/www/nomur
   npm run build:mp-weixin
   ```

3. **下载新构建产物**
   ```bash
   # 在本地电脑执行
   scp -r your_user@your_server_ip:/var/www/nomur/dist/build/mp-weixin ~/Downloads/nomur-miniprogram
   ```

4. **在微信开发者工具中更新**
   - 打开微信开发者工具
   - 如果项目已打开，点击"编译"按钮刷新
   - 如果是新项目，重新导入新的构建目录

5. **测试验证**
   - 在开发者工具中测试新功能
   - 使用"预览"功能在真机上测试

6. **上传新版本**
   - 点击"上传"按钮
   - 填写新的版本号和更新说明

7. **提交审核**
   - 在微信公众平台提交审核
   - 等待审核通过后发布

> ⚠️ **重要**：每次代码修改后，必须重新构建才能生效！

---

## 常见问题排查

### 1. 接口请求失败 / 报"url not in domain list"

**问题现象**：
- 控制台报错：`url not in domain list`
- 网络请求失败

**解决方案**：
1. 检查微信公众平台是否已配置服务器域名
2. 确认域名配置正确：
   - ✅ 必须是 `https://100nomur.net`（不能带 `/api`）
   - ✅ 必须是 HTTPS（不能是 HTTP）
3. 配置后等待 5-10 分钟生效
4. 清除小程序缓存后重试

### 2. 开发者工具里能用，真机不行

**问题现象**：
- 开发者工具中功能正常
- 真机预览时接口请求失败

**原因分析**：
- 开发者工具勾选了"不校验合法域名"
- 真机环境会严格校验服务器域名

**解决方案**：
1. 在微信公众平台正确配置服务器域名
2. 确保 HTTPS 证书有效
3. 在真机上清除小程序缓存
4. 重新打开小程序

### 3. 图片上传失败

**问题现象**：
- 选择图片后上传失败
- 报错：`uploadFile:fail url not in domain list`

**解决方案**：
1. 检查 `uploadFile 合法域名` 是否已配置
2. 确认域名是 `https://100nomur.net`（不带路径）
3. 检查后端上传接口 `/api/upload` 是否可访问：
   ```bash
   curl -I https://100nomur.net/api/upload
   ```
4. 检查后端服务是否正常运行：
   ```bash
   pm2 list
   pm2 logs nomur-api
   ```

### 4. 代码改了但小程序没生效

**问题现象**：
- 修改了源代码
- 但小程序中还是旧代码

**解决方案**：
1. ✅ **必须重新构建**：
   ```bash
   cd /var/www/nomur
   npm run build:mp-weixin
   ```
2. ✅ **重新下载构建产物到本地**
3. ✅ **在微信开发者工具中刷新**：
   - 点击"编译"按钮
   - 或关闭项目后重新导入
4. ✅ **重新上传代码**：
   - 点击"上传"按钮
   - 填写新版本号

### 5. 构建失败

**问题现象**：
- 执行 `npm run build:mp-weixin` 报错
- 构建过程中断

**解决方案**：
1. 检查 Node.js 版本（建议 18+）：
   ```bash
   node -v
   ```
2. 重新安装依赖：
   ```bash
   rm -rf node_modules package-lock.json
   npm install
   ```
3. 检查磁盘空间：
   ```bash
   df -h
   ```
4. 查看详细错误信息，根据错误提示解决

### 6. 小程序页面白屏

**问题现象**：
- 打开小程序后页面空白
- 控制台有错误信息

**解决方案**：
1. 查看开发者工具控制台的错误信息
2. 检查 `app.json` 配置是否正确
3. 检查页面路径是否正确
4. 检查 API 请求是否正常
5. 清除缓存后重试

### 7. 真机预览二维码无法打开

**问题现象**：
- 扫描预览二维码后无法打开小程序

**解决方案**：
1. 确认已配置服务器域名
2. 确认 AppID 配置正确
3. 确认当前微信账号有权限访问该小程序
4. 尝试重新生成预览二维码

### 8. 审核被拒

**常见原因**：
- 类目选择不正确
- 隐私政策未配置
- 功能描述不清晰
- 测试账号无法使用

**解决方案**：
1. 查看审核反馈，了解具体原因
2. 根据反馈修改后重新提交
3. 确保测试账号可用
4. 完善小程序信息描述

---

## 📚 相关资源

- [微信小程序官方文档](https://developers.weixin.qq.com/miniprogram/dev/framework/)
- [uni-app 官方文档](https://uniapp.dcloud.net.cn/)
- [微信开发者工具下载](https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html)
- [微信公众平台](https://mp.weixin.qq.com/)

---

## ✅ 部署执行清单（按步骤执行）

### 📋 阶段一：准备工作

- [ ] **1.1** 已注册微信小程序账号
- [ ] **1.2** 已完成主体认证（未认证会限制服务器域名配置）
- [ ] **1.3** 已获取小程序 AppID（登录微信公众平台 → 开发 → 开发管理 → 开发设置）
- [ ] **1.4** 已安装微信开发者工具（如未安装，下载地址：https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html）
- [ ] **1.5** 已配置好服务器 SSH 访问（用于下载构建产物）

### 📋 阶段二：配置 AppID（必须）

- [ ] **2.1** 打开文件 `/var/www/nomur/src/manifest.json`
- [ ] **2.2** 找到 `mp-weixin` 配置项
- [ ] **2.3** 将 `appid` 字段改为你的真实 AppID（格式：`wx1234567890abcdef`）
- [ ] **2.4** 保存文件

### 📋 阶段三：配置服务器域名（必须，否则真机/线上无法请求接口）

- [ ] **3.1** 登录微信公众平台（https://mp.weixin.qq.com/）
- [ ] **3.2** 进入：**开发** → **开发管理** → **开发设置** → **服务器域名**
- [ ] **3.3** 在 **request 合法域名** 中添加：`https://100nomur.net`
- [ ] **3.4** 在 **uploadFile 合法域名** 中添加：`https://100nomur.net`
- [ ] **3.5** 在 **downloadFile 合法域名** 中添加：`https://100nomur.net`
- [ ] **3.6** 点击"保存"按钮
- [ ] **3.7** 等待 5-10 分钟让配置生效

> ⚠️ **注意**：域名必须是 HTTPS，不能带路径和端口号

### 📋 阶段四：服务器侧确认（后端已上线时通常不用改）

- [ ] **4.1** 检查后端服务是否正常运行：
  ```bash
  pm2 list
  pm2 logs nomur-api
  ```
- [ ] **4.2** 测试 API 是否可访问：
  ```bash
  curl -I https://100nomur.net/api
  ```

### 📋 阶段五：构建小程序产物（必须）

- [ ] **5.1** 登录服务器：
  ```bash
  ssh your_user@your_server_ip
  ```
- [ ] **5.2** 进入项目目录：
  ```bash
  cd /var/www/nomur
  ```
- [ ] **5.3** 安装依赖（如果未安装或依赖有更新）：
  ```bash
  npm install
  ```
- [ ] **5.4** 执行构建命令：
  ```bash
  npm run build:mp-weixin
  ```
- [ ] **5.5** 等待构建完成（通常 1-3 分钟）
- [ ] **5.6** 验证构建结果：
  ```bash
  ls -la /var/www/nomur/dist/build/mp-weixin
  ```
  确认目录存在且包含 `app.js`、`app.json` 等文件

### 📋 阶段六：下载构建产物到本地

- [ ] **6.1** 在本地电脑执行下载命令（使用 SCP）：
  ```bash
  scp -r your_user@your_server_ip:/var/www/nomur/dist/build/mp-weixin ~/Downloads/nomur-miniprogram
  ```
  或使用 SFTP 工具（如 FileZilla、WinSCP）下载整个 `mp-weixin` 目录

### 📋 阶段七：导入微信开发者工具并预览（必须）

- [ ] **7.1** 打开微信开发者工具
- [ ] **7.2** 点击"+" 或"导入项目"按钮
- [ ] **7.3** 填写项目信息：
  - **项目目录**：选择刚才下载的 `mp-weixin` 目录（本地路径）
  - **AppID**：选择你的小程序 AppID（必须与 `manifest.json` 中配置的一致）
  - **项目名称**：可以自定义，如 "Nomur微商管理"
- [ ] **7.4** 点击"导入"按钮
- [ ] **7.5** 配置本地调试设置：
  - 点击右上角的"详情"按钮
  - 在"本地设置"标签页中，勾选 **"不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书"**（仅用于本地调试）
- [ ] **7.6** 在开发者工具中测试功能：
  - 页面能否正常打开
  - API 请求是否正常（查看控制台 Network）
  - 图片上传功能是否正常
  - 数据展示是否正常
- [ ] **7.7** 使用"预览"功能在真机上测试（⚠️ 真机预览时，必须已配置服务器域名）

### 📋 阶段八：上传代码到微信后台

- [ ] **8.1** 在微信开发者工具中，点击工具栏右上角的"上传"按钮
- [ ] **8.2** 填写版本信息：
  - **版本号**：如 `1.0.0`（建议遵循语义化版本规范）
  - **项目备注**：描述本次更新的内容，如"首次发布"、"修复XX问题"等
- [ ] **8.3** 点击"上传"按钮
- [ ] **8.4** 确认上传成功提示

### 📋 阶段九：提交审核与发布（上线流程）

- [ ] **9.1** 登录微信公众平台（https://mp.weixin.qq.com/）
- [ ] **9.2** 进入：**管理** → **版本管理**
- [ ] **9.3** 在"开发版本"中找到刚才上传的版本
- [ ] **9.4** 点击"提交审核"按钮
- [ ] **9.5** 填写审核信息：
  - **版本描述**：说明本次更新的功能或修复
  - **测试账号**（如需要）：提供测试账号和密码
  - **类目**：选择小程序所属类目（必须选择）
  - **隐私设置**：配置用户隐私保护指引（如涉及用户信息收集）
- [ ] **9.6** 提交审核，等待审核结果（通常 1-7 个工作日）
- [ ] **9.7** 审核通过后，在"版本管理"的"审核版本"中点击"发布"按钮
- [ ] **9.8** 确认发布，小程序正式上线

### 📋 阶段十：发布后验证

- [ ] **10.1** 等待几分钟到半小时让发布生效
- [ ] **10.2** 通过搜索小程序名称验证是否能找到
- [ ] **10.3** 扫码测试小程序功能是否正常
- [ ] **10.4** 验证所有功能模块是否正常工作

---

## ✅ 快速检查清单（发布前最终确认）

在正式发布前，请确认以下事项：

- [ ] AppID 已正确配置在 `src/manifest.json`
- [ ] 服务器域名已在微信公众平台配置（request/upload/download）
- [ ] 后端 API 服务正常运行
- [ ] 已执行构建命令并成功生成构建产物
- [ ] 已在微信开发者工具中导入并测试
- [ ] 真机预览功能正常
- [ ] 已上传代码到微信后台
- [ ] 已提交审核并填写完整信息
- [ ] 审核通过后已发布上线

---

**最后更新**：2025-01-06  
**文档版本**：v2.0


