# 新功能验证指南

> **更新日期**：2024-12-20

---

## ✅ 验证清单

### 1. 数据库验证（已完成）

- ✅ `supplement_sales` 表已创建
- ✅ `payment_accounts.balance` 字段已添加
- ✅ `transactions.payment_account_id` 字段已存在
- ✅ `transactions.reason` 枚举值已更新（包含 withdraw、fee、other）

### 2. 后端API验证

#### 2.1 补充数据API

**测试接口：**
```bash
# 测试补充数据API（需要先有一个代理ID）
curl -X POST http://127.0.0.1:3001/api/agents/a1/supplement-sales \
  -H "Content-Type: application/json" \
  -d '{
    "productType": "productA",
    "quantity": 50,
    "saleDate": "2024-12-20",
    "remark": "测试补充数据"
  }'
```

**预期结果：** 返回 `{"code":0,"message":"补充数据成功",...}`

#### 2.2 收款账户余额API

**测试接口：**
```bash
# 获取收款账户余额明细
curl http://127.0.0.1:3001/api/payment-accounts/pay1/balance-details
```

**预期结果：** 返回账户信息和交易记录

### 3. 前端页面验证

#### 3.1 补充数据功能

**验证步骤：**

1. 打开系统：https://nomur.linkmate.site
2. 选择"管理端"
3. 进入"代理管理"（底部Tab的"客户"）
4. 点击任意一个代理商，进入详情页
5. **验证点：**
   - ✅ 在操作按钮区域，应该看到5个按钮（充值、扣款、调货、**补充数据**、订单）
   - ✅ 点击"补充数据"按钮，应该弹出弹窗
   - ✅ 弹窗中可以选择产品类型（A产品/混合产品）
   - ✅ 可以输入数量、选择日期、填写备注
   - ✅ 点击"确认补充"后，应该提示成功

**测试操作：**
1. 选择一个代理商（如：张三）
2. 记录当前的任务完成率（A产品完成数）
3. 点击"补充数据"，补充50箱A产品
4. 刷新页面，检查任务完成率是否增加了50箱
5. **重要：** 检查代理商的余额是否没有变化（余额不应该增加）

#### 3.2 收款账户余额管理功能

**验证步骤：**

1. 在管理端，进入"财务管理"（底部Tab）
2. **验证点1：快捷操作**
   - ✅ 应该看到4个快捷按钮（充值、扣款、调货、**收款账户**）
   - ✅ "收款账户"按钮是紫色背景

3. **验证点2：收款账户列表**
   - ✅ 点击"收款账户"按钮，弹出账户列表
   - ✅ 每个账户显示名称和余额
   - ✅ 余额支持负数显示（红色）

4. **验证点3：收款账户详情**
   - ✅ 点击任意账户，进入详情页
   - ✅ 显示余额卡片（蓝色渐变背景）
   - ✅ 显示余额明细列表（收款和扣费）
   - ✅ 有筛选功能（全部/收款/扣费）
   - ✅ 底部有"扣费"按钮

5. **验证点4：收款账户扣费**
   - ✅ 点击"扣费"按钮，弹出扣费弹窗
   - ✅ 可以选择扣费原因（提现、手续费、其他）
   - ✅ 可以输入金额和备注
   - ✅ 确认扣费后，余额应该减少
   - ✅ 余额明细中应该出现扣费记录

**测试操作：**
1. 选择一个收款账户（如：公司对公账户）
2. 记录当前余额
3. 进行一笔扣费操作（如：提现1000元）
4. 检查余额是否减少了1000元
5. 检查余额明细中是否有扣费记录

---

## 🔍 快速验证命令

### 检查数据库
```bash
# 检查补充数据表
mysql -h 8.154.33.100 -P 3306 -u root -pXk9mP2vL5nQ8wR3jF6yH1bT4cU7eA0sDzGqW nomur -e "SELECT COUNT(*) as count FROM supplement_sales;"

# 检查收款账户余额字段
mysql -h 8.154.33.100 -P 3306 -u root -pXk9mP2vL5nQ8wR3jF6yH1bT4cU7eA0sDzGqW nomur -e "SELECT id, name, balance FROM payment_accounts LIMIT 3;"
```

### 检查API接口
```bash
# 测试健康检查
curl http://127.0.0.1:3001/api/health

# 测试收款账户列表（应该返回balance字段）
curl http://127.0.0.1:3001/api/payment-accounts | jq '.data[0].balance'
```

### 检查代码文件
```bash
# 检查前端是否包含新功能
grep -r "补充数据" src/pages/admin/agents/detail.vue
grep -r "收款账户" src/pages/admin/finance/index.vue

# 检查API文件
grep -r "supplementApi" src/api/index.ts
grep -r "getBalanceDetails" src/api/index.ts
```

---

## 📋 功能验证清单

### 补充数据功能
- [ ] 代理详情页显示"补充数据"按钮
- [ ] 点击按钮弹出补充数据弹窗
- [ ] 可以选择产品类型（A产品/混合产品）
- [ ] 可以输入数量、选择日期、填写备注
- [ ] 补充数据后，任务完成率增加
- [ ] **重要：** 代理商余额不变（验证不影响余额）

### 收款账户余额管理
- [ ] 财务管理页显示"收款账户"按钮
- [ ] 点击按钮显示账户列表（含余额）
- [ ] 点击账户进入详情页（显示余额卡片）
- [ ] 余额明细列表显示交易记录
- [ ] 筛选功能正常（全部/收款/扣费）
- [ ] 扣费功能正常（余额减少，记录保存）

---

## 🐛 如果遇到问题

### 问题1：补充数据按钮不显示
**检查：**
- 刷新浏览器缓存（Ctrl+F5）
- 检查浏览器控制台是否有错误
- 确认代码已部署到服务器

### 问题2：API返回404错误
**检查：**
- 后端服务是否正常运行：`pm2 status nomur-api`
- 检查API路由是否正确：`grep "supplement-sales" server/index.js`

### 问题3：数据库操作失败
**检查：**
- 数据库连接是否正常
- 表结构是否正确：`DESC supplement_sales`
- 字段是否存在：`DESC payment_accounts`

---

## 📞 验证完成确认

完成验证后，请确认：

- [ ] 补充数据功能正常工作
- [ ] 收款账户余额管理功能正常工作
- [ ] 所有API接口响应正常
- [ ] 数据库表结构正确
- [ ] 前端页面显示正常

---

*验证完成后，新功能即可正式使用！*

