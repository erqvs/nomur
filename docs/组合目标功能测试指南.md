# 组合目标功能测试指南

## 功能说明
支持两种年度目标设置方式：
1. **单个产品目标**：每个产品独立设置目标（如：芒果果汁 10000箱）
2. **组合产品目标**：多个产品共享一个总目标（如：茉莉茶 + 龙井茶 共30000箱）

## 测试步骤

### 一、设置组合目标

#### 1. 进入代理编辑页面
- 打开管理端
- 进入"代理管理"页面
- 选择一个代理，点击"编辑"按钮

#### 2. 设置单个产品目标
- 在"年度目标（箱/年）"区域
- 找到"芒果果汁"产品
- 直接输入或使用 +/- 按钮设置目标：**10000箱**
- 不需要勾选复选框（单个目标）

#### 3. 设置组合目标
- 找到"茉莉茶"产品
- **勾选**产品名称左侧的复选框 ✓
- 找到"龙井茶"产品
- **勾选**产品名称左侧的复选框 ✓
- 此时会显示"组合目标设置"区域
- 在"总目标"输入框中输入：**30000箱**
- 点击"保存组合"按钮
- 系统提示"组合目标已保存"

#### 4. 验证设置结果
- "茉莉茶"和"龙井茶"应该显示"已加入组合"标签
- 这两个产品不再显示数量输入框
- 点击"保存修改"按钮保存代理信息

### 二、查看组合目标显示

#### 1. 管理端查看
- 进入代理详情页
- 查看"年度目标完成率"卡片
- 应该看到：
  - **芒果果汁**：10000箱（单个目标）
  - **茉莉茶 + 龙井茶**：30000箱（组合目标）

#### 2. 代理端查看
- 使用代理账号登录
- 进入首页
- 查看"年度任务进度"卡片
- 应该看到相同的显示：
  - **芒果果汁**：10000箱
  - **茉莉茶 + 龙井茶**：30000箱

### 三、验证统计计算

#### 1. 创建订单测试
- 为测试代理创建一个订单
- 订单包含：
  - 茉莉茶：5000箱
  - 龙井茶：3000箱
- 完成订单（发货扣款）

#### 2. 查看完成率
- 进入代理详情页
- 查看"年度目标完成率"
- **茉莉茶 + 龙井茶**的完成情况应该是：
  - 已完成：8000箱（5000 + 3000）
  - 目标：30000箱
  - 完成率：26.67%（8000/30000）

#### 3. 验证单个目标
- **芒果果汁**的完成情况：
  - 如果订单中没有芒果果汁，完成率应该是 0%
  - 如果有芒果果汁订单，应该单独计算

### 四、测试场景

#### 场景1：纯组合目标
- 设置：茉莉茶 + 龙井茶 = 30000箱
- 订单：茉莉茶 10000箱，龙井茶 5000箱
- 预期：组合完成 15000箱，完成率 50%

#### 场景2：混合目标
- 设置：
  - 芒果果汁 = 10000箱（单个）
  - 茉莉茶 + 龙井茶 = 30000箱（组合）
- 订单：
  - 芒果果汁 5000箱
  - 茉莉茶 8000箱
  - 龙井茶 7000箱
- 预期：
  - 芒果果汁：5000/10000 = 50%
  - 茉莉茶+龙井茶：15000/30000 = 50%

#### 场景3：修改组合目标
- 已设置：茉莉茶 + 龙井茶 = 30000箱
- 操作：
  1. 进入编辑页面
  2. 勾选茉莉茶和龙井茶
  3. 修改总目标为 50000箱
  4. 保存组合
- 预期：组合目标更新为 50000箱

#### 场景4：取消组合
- 已设置：茉莉茶 + 龙井茶 = 30000箱
- 操作：
  1. 进入编辑页面
  2. 勾选茉莉茶和龙井茶
  3. 点击"取消组合"
- 预期：组合被取消，两个产品恢复为独立目标（目标为0）

### 五、数据验证（数据库）

#### 查看数据库存储
```sql
SELECT id, name, yearly_targets FROM agents WHERE name = '测试代理名称';
```

#### 预期数据结构
```json
{
  "p1": 10000,
  "_group_1234567890": {
    "products": ["p2", "p3"],
    "target": 30000
  }
}
```

其中：
- `p1` = 芒果果汁的产品ID
- `p2` = 茉莉茶的产品ID
- `p3` = 龙井茶的产品ID
- `_group_1234567890` = 组合目标的唯一标识

### 六、常见问题排查

#### 问题1：组合目标不显示
- 检查：是否点击了"保存组合"按钮
- 检查：是否至少选择了2个产品
- 检查：是否输入了总目标值

#### 问题2：完成率计算错误
- 检查：订单中的产品ID是否匹配
- 检查：订单是否在当年创建
- 检查：订单是否排除了赠品

#### 问题3：组合目标无法修改
- 检查：是否先勾选了组合中的产品
- 检查：是否点击了"保存组合"而不是"保存修改"

### 七、测试检查清单

- [ ] 可以设置单个产品目标
- [ ] 可以设置组合产品目标（2个产品）
- [ ] 可以设置组合产品目标（3个或更多产品）
- [ ] 组合目标正确显示在管理端
- [ ] 组合目标正确显示在代理端
- [ ] 组合目标的完成量正确计算（多个产品之和）
- [ ] 组合目标的完成率正确计算
- [ ] 可以修改组合目标
- [ ] 可以取消组合目标
- [ ] 数据库存储格式正确

## 完成标准

所有测试场景通过，组合目标功能正常工作，数据计算准确。

